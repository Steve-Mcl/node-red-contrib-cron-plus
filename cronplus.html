

<script type="text/javascript">
(function(){

    var map, mapPopup, selectedLocation, selectedLocationInput;

    var filesadded="" //list of files already added 
    function checkloadjscssfile(filename, filetype){
        if (filesadded.indexOf("["+filename+"]")==-1){
            loadjscssfile(filename, filetype)
            filesadded+="["+filename+"]" //List of files added in the form "[filename1],[filename2],etc"
        }
    }

    function loadjscssfile(filename, filetype){
        if (filetype=="js"){ //if filename is a external JavaScript file
            var fileref=document.createElement('script')
            fileref.setAttribute("type","text/javascript")
            fileref.setAttribute("src", filename)
        }
        else if (filetype=="css"){ //if filename is an external CSS file
            var fileref=document.createElement("link")
            fileref.setAttribute("rel", "stylesheet")
            fileref.setAttribute("type", "text/css")
            fileref.setAttribute("href", filename)
        }
        if (typeof fileref!="undefined")
            document.getElementsByTagName("head")[0].appendChild(fileref)
    }
    
    function safeFloat(value, def) {
        if ((undefined === value) || (null === value)) {
            return def || 0.0;
        }
        try {
            value = parseFloat(value);
        } catch (e) {
            value = def || 0.0;
        }
        if (isNaN(value)) {
            return def || 0.0;
        }
        return value;
    }
    function createMap(srcInput) {
        if(!window.L || navigator.onLine === false){
            $(".map-not-loaded").show();
            $("#map").hide();
            return;
        }
        $("#map").show();
        $(".map-not-loaded").hide();
        var lat, lon;
        var latlon = srcInput.val();
        if(latlon){
            var arrLatlon = latlon.split(" ");
            if(arrLatlon.length < 2)
                arrLatlon = latlon.split(",");
            if(arrLatlon.length >= 2){
                lat = arrLatlon[0];
                lon = arrLatlon[1];
            }
        }
        console.log("createMap", lat, lon)
        var zoom = 3;//by default, zoomed out
        var showPopupOnOpen = false;
        if (lat != undefined && lon != undefined) {
            showPopupOnOpen = true;
            zoom = 5;//if location is set, zoom in a bit
        }
        lat = safeFloat(lat, 50.0);
        lon = safeFloat(lon, 0.0);
        console.log("lat/lon", lat, lon)
        selectedLocation = window.L.latLng(lat, lon);
        console.log("selectedLocation", selectedLocation.lat, selectedLocation.lng)

        // create leaflet map
        map = window.L.map('map', {
            zoomControl: true,
            center: selectedLocation, //[selectedLocation.lat,selectedLocation.lng],
            zoom: zoom
        });
        mapPopup = window.L.popup();

        map.on('click', function (e) {
            console.log(e);
            showMapPopup(e.latlng.lat, e.latlng.lng, map);
            selectedLocation = e.latlng
            // $("#lng").val(e.latlng.lng);
            // $("#lat").val(e.latlng.lat);
        });


        function showMapPopup(lat, lon, map) {
            var content =
                '<div><span>Lat:</span> <span>' + lat + '</span></div>' +
                '<div><span>Lon:</span> <span>' + lon + '</span></div>'
            mapPopup
                .setLatLng([lat, lon])
                .setContent(content)
                .openOn(map);
        }


        // add a base layer
        var tileUrl = "http://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}.png";
        //var tileUrl = "http://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}.png";
        var layer = L.tileLayer(tileUrl, {});
        layer.addTo(map);
        // add cartodb layer with one sublayer
        cartodb.createLayer(map, {
            user_name: 'node-red',
            type: 'namedmap',
            options: {
                named_map: {
                    name: 'node-red@cronplus',
                    params: {
                        "color": "#5CA2D1"
                    },
                    layers: [{}]
                }
            }
        })
            .addTo(map)
            .done(function (layer) {
                layer.setInteraction(true);
                if (showPopupOnOpen) {
                    showMapPopup(selectedLocation.lat, selectedLocation.lng, map);
                }

                layer.on('featureClick', function (e, latlng, pos, data, layer) {
                    console.log("click", latlng, data);
                });
            });

    }


    function updateEditorLayout(){
        console.log("cronplus-updateEditorLayout")
        var dlg = $("#dialog-form");
        var height = dlg.height() - 5;
        var expandRow = dlg.find('.form-row-auto-height');
        if(expandRow && expandRow.length){
            let childRows = dlg.find('.form-row:not(.form-row-auto-height)');
            for (var i=0; i<childRows.size(); i++) {
                var cr = $(childRows[i]);
                if(cr.is(":visible"))
                    height -= cr.outerHeight(true);
            }
            let ol = $(expandRow.find(".red-ui-editableList-list"));
            if(ol && ol.length){
                ol.editableList("height",height);
            } else {
                expandRow.css("height",height+"px");
            }
        } 
    }

    RED.nodes.registerType('cronplus', {
        category: "input",
        icon: "timer.png",
        color: "#a6bbcf",
        inputs: 1,
        outputs: 1,
        outputLabels: ["Output","Command Responses"],
        defaults: {
            name: { value: "" },
            outputField: { value: "payload" },
            timeZone: { value: "" },
            commandResponseMsgOutput: { value: "output1" },
            outputs: { value: 1 },
            options: {
                value:[{payload: '', topic : '', expression : ''}], 
                validate:function(value) { 
                    if (value.length) {
                        for (var i = 0; i < value.length; i++) {
                            if(!value[i].topic){
                                return false;
                            }
                            if (!value[i].expressionType || value[i].expressionType === "cron") {
                                if (!value[i].expression) {
                                    return false;
                                }
                            } else if(value[i].expressionType === "sunrise" || value[i].expressionType === "sunset") {
                                if (!value[i].location) {
                                    return false;
                                }
                            }
                        }
                    }
                    return true;
                },
                required: true
            },
        },
        label: function () {
            return this.name || "CRON+"
        },
        oneditprepare: function () {
            $( "#mapDialog" ).dialog({
                autoOpen: false,
                height: 400,
                width: 700,
                modal: true,
                buttons: {
                    "OK": function(){
                    if(selectedLocation && selectedLocationInput){
                        selectedLocationInput.val(selectedLocation.lat + " " + selectedLocation.lng);
                    }
                    $( "#mapDialog" ).dialog( "close" );
                    },
                    Cancel: function() {
                    $( "#mapDialog" ).dialog( "close" );
                    }
                },
                show: {
                    effect: "blind",
                    duration: 1000
                },
                hide: {
                    effect: "explode",
                    duration: 1000
                },
                close: function( event, ui ) {
                    console.log("destroying map")
                    if(map) map.remove();
                },
                create: function() {
                    //$("#dialog").append(footer);
                }
                });
            //<!-- include cartodb.js library -->
            let proto = location.protocol === 'https:' ? location.protocol : "http:"
            checkloadjscssfile(proto + "//libs.cartocdn.com/cartodb.js/v3/3.11/themes/css/cartodb.css","css");
            checkloadjscssfile(proto + "//libs.cartocdn.com/cartodb.js/v3/3.11/cartodb.uncompressed.js","js");
 
            var node = this;
            $( "#node-input-timeZone" ).autocomplete({
                source: function( request, response ) {
                    var matcher = new RegExp( $.ui.autocomplete.escapeRegex(request.term), "i" );
                    $.ajax({
                        url: 'cronplustz',
                        type: 'POST',
                        datatype: 'json'
                    })
                    .done(function (data) { 
                        response($.map(data, function(item){
                            if(item && item.tz){
                                var label = (item.code ? item.code + ", " : "") + item.tz + " (UTC: " + item.UTCOffset + ", DST: " + item.UTCDSTOffset + ")";
                                if ( label && ( !request.term || matcher.test(label) ) ) {
                                    return {
                                        label: label,
                                        value: item
                                    };
                                }
                            }
                        }));
                    })
                    .fail(function (jqXHR, textStatus, errorThrown) { 
                        console.error(jqXHR,textStatus,errorThrown)
                    });
                },
                minLength: 2,
                open: function() {
                    $( this ).removeClass( "ui-corner-all" ).addClass( "ui-corner-top" );
                },
                close: function() {
                    $( this ).removeClass( "ui-corner-top" ).addClass( "ui-corner-all" );
                },
                focus: function (event, ui) {
                    event.preventDefault();
                    $("#node-input-timeZone").val(ui.item.label);
                },
                select: function (event, ui) {
                    event.preventDefault();
                    this.value = ui.item.value.tz;
                }
            });

            var formatDateTimeWithTZ = function (date, tz) {
                if (!date) {
                    return "";
                }
                let datestring;
                let o = {
                    timeZone: tz ? tz : undefined,
                    timeZoneName: "short",
                    hour12: false,
                    year: "numeric",
                    month: "short",
                    day: "2-digit",
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit"
                };
                try {
                    datestring = new Intl.DateTimeFormat('default', o).format(new Date(date))
                } catch (error) {
                    datestring = "Error. Check timezone setting"
                }
                return datestring;
            }
           
            function generateOption(i, option) {
                function buildExpresionTip(title, desc, text){
	                return '<div><p style="font-size: 12px; font-weight: bold">' + title + '</p>' +
                            '<div>' + desc + '</div>' +
                            '<pre  class="form-tip">' + text + '</pre></div>'
                }
                function initTooltip(selector, type){
                    var pos = { my: "right top", at: "right+90 bottom+5", of: selector, collision: "flipfit" };
                    selector.off("mouseenter").tooltip({
                        show: { effect: "fade" },
                        tooltipClass: "expression-tip",
                        position: pos,
                        content: function () { return buildExpresionTip("Expression...", "Getting description...","") } ,
                        disabled: true
                    }).off('focusout').off('mouseleave').mouseleave(function(e){
                        console.log("initTooltip--mouseleave")
                        if (selector.is(':focus')) {
                            console.log("initTooltip--mouseleave selector:is(':focus')")
                            e.preventDefault();
                            e.stopImmediatePropagation();
                            selector.tooltip('open');
                            return false;
                        }
                    }).on("blur", function () {
                        console.log("initTooltip-->on-blur")
                        $(this).tooltip("close").tooltip("disable");
                    }).on("focusin change keyup", function (e) {
                        console.log("initTooltip--focusin change keyup",e )
                        var $this = $(this);
                        var expression = $this.val();
                        let $timeZone = $("#node-input-timeZone");
                        var $expressionType = $this.closest("li").find(".node-input-option-expressionType");
                        var $offset = $this.closest("li").find(".node-input-option-offset");
                        if(!expression){
                            $this.tooltip("close").tooltip("disable");
                            return;
                        }
                        $this.tooltip("option", "position", pos);
                        $this.tooltip("enable").tooltip("open");
                        $this.tooltip({ 
                            position: pos,
                            disabled: false,
                            show: { effect: "fade" },
                            content: function (callback) {
                                console.log("initTooltip-->content")
                                expression = $this.val();
                                var expressionType = $expressionType.val();
                                var offset = $offset.val();
                                let timeZone = $timeZone.val();
                                var title_html = 'Description of <span class="cron-expression">' + expression.slice(0,100) + (expression.length > 100 ? "..." : "") + '</span>';
                                let e = { expressionType: expressionType };
                                if (timeZone) e.timeZone = timeZone;
                                if(expressionType == "sunset" || expressionType == "sunrise"){
                                    title_html = '<b>' + expressionType + '</b> at <span class="cron-expression">' + expression.slice(0,100) + (expression.length > 100 ? "..." : "") + '</span>';
                                    if(offset != undefined && offset != null && offset != "0" && offset != 0){
                                        title_html += '<b>';
                                        if(offset > 0) title_html += ' +'
                                        title_html += offset + ' minute';
                                        if(offset != "1" && offset != "-1") title_html += 's'
                                        title_html += '</b>';
                                    }
                                    e.offset = offset;
                                    e.location = expression;
                                } else {
                                    title_html = 'Description of <span class="cron-expression">' + expression.slice(0,100) + (expression.length > 100 ? "..." : "") + '</span>';
                                    e.expression = expression;
                                }

                                $.ajax({
                                    url: 'cronplus',
                                    type: 'POST',
                                    data: e,
                                    datatype: 'json'
                                })
                                .done(function (data) {
                                    console.log("initTooltip-->Ajax done, data...",data)
                                    let nextInfo = "";
                                    let desc = data.description;
                                    if (data.prettyNext) {
                                        nextInfo = "Next run...\n- " + data.prettyNext;
                                        if (data.nextDates && data.nextDates.length) {
                                            let map1;
                                            if (timeZone) {
                                                map1 = data.nextDates.map(function(x) {
                                                    let fd = formatDateTimeWithTZ(x, timeZone);
                                                    return fd ? fd : undefined;
                                                });
                                            } else {
                                                map1 = data.nextDates.map(function(x) {return (new Date(x)).toString()});
                                            }
                                            nextInfo += "\n- at " + map1.join("\n- at ");
                                        }
                                    }
                                    var okcontent = function(){
                                        setTimeout(function(){
                                            console.log("initTooltip-->callback-->setTimeout--> option-->position");
                                            $this.tooltip("option", "position", pos);
                                            $this.tooltip("enable").tooltip("open");
                                        },100)
                                        return buildExpresionTip(title_html, desc, nextInfo);
                                    } 
                                    callback(okcontent);
                                })
                                .fail(function (jqXHR, textStatus, errorThrown) {
                                    console.error(jqXHR, textStatus, errorThrown)
                                    var errcontent = buildExpresionTip("Error...", "Cannot get description from node-red","");
                                    callback(errcontent);
                                });
                            } 
                        });
                    });
                }
                
                var container = $('<li/>',{style:"background: #fff; margin:0; padding:8px 0px 0px; border-bottom: 1px solid #ccc;"});
                var row = $('<div/>').appendTo(container);
                var row2 = $('<div/>',{style:"padding-top:5px; padding-left:175px;"}).appendTo(container);
                var row3 = $('<div/>',{style:"padding-top:5px; padding-left:120px;"}).appendTo(container);
                
                var div = row.append( '<div/>' )

                var span = $('<span/>',{style:"float:right; margin-right:5px;"}).appendTo(div);
                var deleteButton = $('<a/>',{href:"#",class:"editor-button editor-button-small", style:"margin-top:7px; margin-left:5px;"}).appendTo(span);
                $('<i/>',{class:"fa fa-remove"}).appendTo(deleteButton);

                //generate a dropdown for trigger type
                var expressionType = option.expressionType || "cron";
                var expressionTypeField = $('<select/>',{class:"node-input-option-expressionType",type:"text",placeholder:"cron"}).css({"width":"15%","margin-left":"5px","margin-right":"5px"}).appendTo(div);
                $('<option />', {value: "cron", text: "cron"}).appendTo(expressionTypeField);
                $('<option />', {value: "sunrise", text: "sunrise"}).appendTo(expressionTypeField);
                $('<option />', {value: "sunset", text: "sunset"}).appendTo(expressionTypeField);
                expressionTypeField.val(expressionType);
                expressionTypeField.prop("title", "Expression Type");   

                //generate the name/topic field
                var topicClass ="node-input-option-topic" + ((!option.topic) ? " input-error" : "");
                var topicField = $('<input/>',{class:topicClass,type:"text",style:"margin-left:5px; width:calc(15% - 16px);", placeholder: 'name',value:option.topic}).appendTo(div);
                
                //generate the payload field
                var payloadField = $('<input/>',{class:"node-input-option-payload",type:"text",style:"margin-left:7px; width:calc(28% - 16px);", placeholder: 'payload', value:option.payload || ""}).appendTo(div);
                payloadField.typedInput({default:option.type||'str',types:['flow', 'global', 'str', 'num', 'bool', 'json', 'bin', 'date', 'env']});

                //generate location 
                var locationGroup = $('<div class="red-ui-typedInput-container" style="margin-left:7px; width: calc(25% - 16px);">' +
                        '<button class="red-ui-typedInput-type-select" title="Show Map..."><i class="fa fa-map-marker "> </i></button>' +
                        '<div class="red-ui-typedInput-input-wrap" style="left: 22px; right: 0px;">' +
                        '<input class="red-ui-typedInput-input node-input-option-location" type="text" value=""></div> </div>');                
                var locationField = locationGroup.find("input");
                var locationButton = locationGroup.find("button");
                locationField.prop("title", "Location coordinates...");
                locationButton.prop("title", "Show Map...");
                if(!option.location){
                    locationGroup.addClass("input-error");
                } else {
                    locationField.val(option.location);
                }
                locationGroup.appendTo(div);

                locationButton.on( "click", function() {
                    selectedLocationInput = $(this).closest("li").find(".node-input-option-location");
                    $( "#mapDialog" ).dialog( "open" );
                    createMap(selectedLocationInput);  
                       
                });

                //offset fields
                var offsetField = $('<input/>',{class: "node-input-option-offset", type:"number", min:-1439, max:1439,style:"margin-left:7px; width:calc(15% - 16px);", value:option.offset || 0, placeholder: "offset"}).appendTo(div);
                offsetField.prop("title", "Minutes Offset +/- 1439");   
              
                var expressionClass = "node-input-option-expression" + ((!option.expression) ? " input-error" : "");
                var expressionField = $('<input/>',{class:expressionClass,type:"text",style:"margin-left:7px; width:calc(37% - 16px);", placeholder: 'expression', value:option.expression}).appendTo(div);
                expressionField.prop("title", "Expression...");

                initTooltip(expressionField,"cron");
                initTooltip(locationField,expressionType);

                expressionField.keyup(function() {
                    var f = $(this);
                    if (f.val() && f.hasClass('input-error')) {
                        f.removeClass('input-error')
                    } else if (!f.val()) {
                        f.addClass('input-error')
                    }
                });
                locationField.keyup(function() {
                    var f = $(this);
                    var fg = locationGroup;
                    if (f.val() && fg.hasClass('input-error')) {
                        fg.removeClass('input-error')
                    } else if (!f.val()) {
                        fg.addClass('input-error')
                    }
                });
            
                topicField.keyup(function() {
                    if ($(this).val() && $(this).hasClass('input-error')) {
                        $(this).removeClass('input-error')
                    } else if (!$(this).val()) {
                        $(this).addClass('input-error')
                    }
                });           

                expressionTypeField.change(function(){
                    var value = expressionTypeField.val();
                    switch (value) {
                        case "sunrise":
                        case "sunset":
                            expressionField.hide();
                            locationGroup.show();
                            offsetField.show();
                            break;
                        default: //cron
                            expressionField.show();
                            locationGroup.hide();
                            offsetField.hide();                            
                            break;
                    }
                });
                expressionTypeField.change();                

                deleteButton.click(function() {
                    container.css({"background":"#fee"});
                    container.fadeOut(300, function() {
                        $(this).remove();
                    });
                });

                $("#node-input-option-container").append(container);
            }

            $("#node-input-add-option").click(function() {
                generateOption($("#node-input-option-container").children().length+1, {});
                $("#node-input-option-container-div").scrollTop($("#node-input-option-container-div").get(0).scrollHeight);
            });

            for (var i=0; i<this.options.length; i++) {
                var option = this.options[i];
                generateOption(i+1,option);
            }

            $( "#node-input-option-container" ).sortable({
                axis: "y",
                handle:".node-input-option-handle",
                cursor: "move"
            });
            updateEditorLayout();
        },
        oneditsave: function () {
            var node = this;
            var ctrlOutput = $("#node-input-commandResponseMsgOutput").val();
            node.outputs = ctrlOutput === "output2" ? 2 : 1;
            var options = $("#node-input-option-container").children();
            node.options = [];
            options.each(function(i) {
                var option = $(this);
                var o = {
                    expressionType: option.find(".node-input-option-expressionType").val(),
                    topic: option.find(".node-input-option-topic").val(),
                    payload: option.find(".node-input-option-payload").typedInput('value'),
                    type: option.find(".node-input-option-payload").typedInput('type'),
                    expression: option.find(".node-input-option-expression").val(),
                    location: option.find(".node-input-option-location").val(),
                    offset: option.find(".node-input-option-offset").val()
                };
                if (option.find(".node-input-option-value").typedInput('type') === "num") {
                    o.payload = Number(o.value);
                }
                if (option.find(".node-input-option-value").typedInput('type') === "bool") {
                    o.payload = (o.value == "true");
                }
                node.options.push(o);
            });

            $("#node-input-timeZone").off();
            $("#node-input-crontab").off();
        },
        button: {
            visible: function () {
                if(this.options && this.options.length == 1){
                    return true;
                }
                return false;
            },
            enabled: function () {
                return !this.changed
            },
            onclick: function () {
                var node = this;
                if (node.changed) {
                    return RED.notify(RED._("notification.warning", { message: RED._("notification.warnings.undeployedChanges") }), "warning");
                }
                var label = node._def.label.call(node);
                if (label.length > 30) {
                    label = label.substring(0, 50) + "...";
                }
                label = label.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                
                $.ajax({
                    url: "cronplus/" + node.id,
                    type: "POST",
                    success: function (resp) {
                        RED.notify(node._("inject.success", { label: label }), { type: "success", id: "inject" });
                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        if (jqXHR.status == 404) {
                            RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.not-deployed") }), "error");
                        } else if (jqXHR.status == 500) {
                            RED.notify(node._("common.notification.error", { message: node._("inject.errors.failed") }), "error");
                        } else if (jqXHR.status == 0) {
                            RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.no-response") }), "error");
                        } else {
                            RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.unexpected", { status: jqXHR.status, message: textStatus }) }), "error");
                        }
                    }
                });
            }
        },
        oneditresize: function(){
            updateEditorLayout()
        }
    });

})();    
</script>

<script type="text/html" data-template-name="cronplus">
    <style>
        .expression-tip {
            background: #ffe;
            width: 100%;
            max-width: 475px;
            <!-- min-height: 350px; -->
            max-height: 460px;
            overflow:auto;
            font-size: 11px;
            } 
        .form-tip {
            background: #ffe;
            padding: 6px 6px;
            vertical-align: middle;           		
            font-size: 12px;
            line-height: 20px;
            box-sizing: border-box;
            overflow: auto;
            word-break: keep-all;
        }
        .form-tip > div {
            white-space: pre-wrap;
        }
        span .form-tip {
            border-radius: 2px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: inline-block;
        }
        .form-tip-spacer {
            display: inline-block;
            width: 100px
        }
        .cron-expression {
            font-family: monospace;
            padding-left: 5px;
            padding-right: 5px;
            text-align: left;
            color: #666;
            background: #ffe;
            height: 30px;
            vertical-align: middle;
            border-top: 1px solid #f0f0f0;
            border-bottom: 1px solid #f0f0f0
        }
        #map {
            /* height: 300px; */
            /* width: 100%; */
            height: 100%;
            padding: 0;
            margin: 0;
        }
        .map-not-loaded {
            padding: 2px 10px 2px 10px;
        }
    </style>
    

    <div id="mapDialog" style="display: none;" title="Choose location...">
        <div class="map-not-loaded"  style="display:hidden" >
            <h3>No internet on this device?</h3>
            <p>The interactive Map is loaded via CDN at client side (to minimise installation size) and therefore requires an internet connection. As you are seeing this message, it is likely this device does not have access to the internet.</p>
            <h4>Alternative ways to get coordinates...</h4>
            <ul> 
                <li>Visit <a href="https://www.latlong.net/" target="_blank" rel="noopener noreferrer">www.latlong.net</a> (on another device if required) then copy the "Lat Long" value provided into the cronplus coordinates box</li>
                <li>Visit google maps, MSN maps, almost any other maps website on another device to get GPS or longitude latitude value</li>
                <li>Try one of the many longitude latitude apps avaiable in the app store on your mobile phone</li>
                <li>Check your satnav device - it may show coordinates</li>
                <li>Use a topographic map</li>
                <li>Ask a friend</li>
            </ul>
            <h4>Accepted formats...</h4>
            <ul>
                <li>Decimal Degrees E.g: <code class="coordinates">54.9992500,-1.4170300</code> or <code class="coordinates">54.9992500° N 1.4170300° W</code></li>
                <li>Degrees Minutes Seconds E.g: <code class="coordinates">54° 59' 57.3'' N 1° 25' 1.308'' W</code></li>
                <li>Decimal Minutes E.g: <code class="coordinates">54° 59.955' , -1° 25.0218'</code></li>
                <li>GPS E.g: <code class="coordinates">N54°59'57.3, W1°25'1.308"</code>, <code class="coordinates">54°59'57.3"N, 1°25'1.308"W</code>, <code class="coordinates">54d 59' 57" N 1d 25' 1" W</code> or <code class="coordinates">54:59:57.3N 1:25:1.308W</code></li>
            </ul>
        </div>
        <div id="map"></div>
    </div>


    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name">Name</span></label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>

    <div class="form-row">
        <label for="node-input-outputField"><i class="fa fa-envelope"></i> Output to</label>
        <input type="text" id="node-input-outputField" placeholder="payload">
    </div>         
    <div class="form-row">
        <label for="node-input-timeZone"><i class="fa fa-globe"></i> Timezone</label>
        <input type="text" id="node-input-timeZone" placeholder="Leave empty for none/system">
    </div>  
    <div class="form-row">
        <label for="node-input-commandResponseMsgOutput"><i class="fa fa-dot-circle-o"></i><span style="font-stretch: condensed;"> Command Resp</span></label>
        <select style="width: 70%" id="node-input-commandResponseMsgOutput">
          <option value="output1">Send to output 1 (default)</option>
          <option value="output2">Send to seperate output</option>
        </select>
      </div>  
    <div id="node-cronplus-tab-static-schedules" class="form-row form-row-auto-height" style="margin-bottom: 0px;width: 100%; min-height: 200px">
        <label for="node-input-option-container-div" style="vertical-align:top"><i class="fa fa-list-alt"></i> Schedules</label>
        <div id="node-input-option-container-div" style="min-width: 350px; box-sizing: border-box; border-radius: 5px; padding: 5px; border: 1px solid #ccc; overflow-y:scroll;display: inline-block; width: 100%; height: calc(100% - 28px); min-height: 150px;">
            <ol id="node-input-option-container" style=" list-style-type:none; margin: 0;"></ol>
        </div>
    </div> 
    <div class="form-row">
        <a href="#" class="editor-button editor-button-small" id="node-input-add-option" style="margin-top: 4px;"><i class="fa fa-plus"></i> <span>option</span></a>
    </div>
</div>

</script>

<script type="text/html" data-help-name="cronplus">
    <p>Schedule the injection of a payload to start a flow</p>
    <h3>Properties...</h3>
    <dl class="message-properties">
        <h4>Output to</h4>
        <div style="padding-left: 15px">
            The <code>msg.</code> property to send the payload to.  Typically this would be payload.
        </div>
        <h4>Timezone (optional)</h4>
        <div style="padding-left: 15px">
            A timezone to use. Leave blank for system timezone. Alternatively, enter UTC or a timezone in the format of Region/Area (<a target="_blank" href="https://en.wikipedia.org/wiki/List_of_tz_database_time_zones">list</a>)
        </div>    
        <h4>Schedules</h4>
        <div style="padding-left: 15px">
            A table of schedules. 
        </div>
        <h4>Schedules - Type</h4>
        <div style="padding-left: 15px">
            The type determines what type of schedule. Options are <code>cron</code>, <code>sunrise</code> or <code>sunset</code>
        </div>
        <h4>Schedules - Name</h4>
        <div style="padding-left: 15px">
            The name is used to both identify the schedule and will be sent in <code>msg.topic</code> when the schedule triggers. This is to permit the user to determine which schedule has triggered.
        </div>
        <h4>Schedules - Payload</h4>
        <div style="padding-left: 15px">
            The value to send in the payload when the schedule triggers. (NOTE: the property that the payload gets written to is determined by "output to").
        </div>        
        <h4>Schedules - Location</h4>
        <div style="padding-left: 15px">
            <i>NOTE: Only displayed when the type is set to <b>sunrise</b> or <b>sunset</b></i><br>
            The location field is expected to contain longitude and lattitude coordinates for the calculation of surise or sunset time.
        </div>        
        <h4>Schedules - Offset</h4>
        <div style="padding-left: 15px">
            <i>NOTE: Only displayed when the type is set to <b>sunrise</b> or <b>sunset</b></i><br>
            The offset field can be used to add a positive or negative offset in minutes to the surise or sunset time.
        </div>        
        <h4>Schedules - Expression</h4>
        <div style="padding-left: 15px">
            <i>NOTE: Only displayed when the type is set to <b>cron</b></i><br>
            A CRON expression, a date, a comma seperated list of dates or an array of dates<br><br>
            <p> Date or Date Sequence Format...<br>
                When you wish to use a fixed date or sequnce of dates, the expression can be a string date, comma separated list of dates, an array of dates (The array can contain a mix of string, date objects and timestamps).
                When specifying a string date, you can use timezone e.g. "2020-01-01 00:00 GMT+2".
                You can even mix time zones e.g. "2020-01-01 00:00 GMT+2, 2020-01-01 00:00 GMT-7"
            </p>
            <p>CRON Format...</p>
            <pre style="white-space: pre">
    s  m  h  md m  wd y
    |  |  |  |  |  |  |
    *  *  *  *  *  *  *    Field              Allowed values    Special symbols
    |  |  |  |  |  |  |    -----------------  ---------------   ---------------
    `--|--|--|--|--|--|->  Second (optional)  0-59              * / , -
       `--|--|--|--|--|->  Minute             0-59              * / , -
          `--|--|--|--|->  Hour               0-23              * / , -
             `--|--|--|->  Day of Month       1-31              * / , - ? L W
                `--|--|->  Month              1-12 or JAN-DEC   * / , -
                   `--|->  Day of Week        0-7 or SUN-SAT    * / , - ? L #
                      `->  Year (optional)    1970-2099         * / , -
            </pre>
            <p>Notes...</p>
            <ul>
                <li><code>*</code> Asterisks indicate that the cron expression matches for all values of the field. For example, "*" in the minute field means every minute</li>
                <li><code>?</code> Question marks are used to specify 'no specific value' and is allowed for the day-of-month and day-of-week fields. It is used instead of the asterisk (*) for leaving either day-of-month or day-of-week blank.</li>
                <li><code>-</code> Hyphens are used to define ranges. For example, "10-12" in the hour field means the hours of 10, 11, and 12.</li>
                <li><code>,</code> Commas are used to separate items of a list. For example, "MON,WED,FRI" in the day-of-week field means the days Monday, Wednesday, and Friday.</li>
                <li><code>/</code> Forward slash are used to indicate increments. For example. "0/15" in the seconds field means the seconds 0, 15, 30, and 45. Additionally, "1/3" in the day-of-month field means every 3 days starting on the first day of the month.</li>
                <li><code>L</code> Short-hand for "last" and is allowed for the day-of-month and day-of-week fields. The "L" character has a different meaning in each of the two fields. For example, "L" in the day-of-month field means the last day of the month. If used in the day-of-week field, it means 7 or SAT. However, if used in the day-of-week field after another value, it means the last xxx day of the month. For example, "6L" in the day-of-week field means the last Friday of the month</li>
                <li><code>W</code> Short-hand for "weekday" and is allowed for the day-of-month field. The "W" character is used to specify the weekday nearest the given day. For example, "15W" in the day-of-month field means the nearest weekday to the 15th of the month. Therefore, if the 15th is a Saturday, the job runs on Friday the 14th. The "L" and "W" characters can be combined in the day-of-month field. For example, "LW" means the last weekday of the month.</li>
                <li><code>#</code> Hash marks specify constructs. For example, "6#3' in the day-of-week field means the third Friday of the month.</li>
            </ul>        
            <p>Examples...</p>
            <ul>
                <li><code>* * * * * *</code> Every Second</li>
                <li><code>0 * * * * *</code> Every minute</li>
                <li><code>0 */10 * * * *</code> Every 10 minutes</li>
                <li><code>0 */20 1 * * *</code> Every 20 minutes, between 01:00 AM and 01:59 AM</li>
                <li><code>0 15,30,45 * * * *</code> At 15, 30, and 45 minutes past the hour</li>
                <li><code>0 0 12 * * *</code> Every day at noon - 12pm</li>
                <li><code>0 0 2 29 FEB * 2020-2040</code> At 02:00 AM, on day 29 of the month, only in February, every 4 years, 2020 through 2040</li>
                <li><code>0 0 7 * * MON#1 *</code> At 07:00 AM, on the first Monday of the month</li>
                <li><code>0 0 12 * JAN,FEB,MAR,APR *</code> Every day at noon in January, February, March and April</li>
                <li><code>* * 1W * *</code> Every minute, on the first weekday of the month</li>
                <li><code>* * * * Tue#3</code> Every minute, on the third Tuesday of the month</li>
                <li><code>0 12 * * MONL</code> At 12:00 PM, on the last Monday of the month</li>
                <li>See <a href="https://github.com/jaclarke/cronosjs">here</a> for more examples and info</li>
            </ul>
        </div>

    </dl>
    <h3>Output</h3>
    <dl class="message-properties">
        <dt><i>payload (see 'Output to')</i> <span class="property-type">number|string|boolean|object|buffer</span></dt>
        <dd>msg.[Output to] will contain whatever is configured in 'payload'</dd>
        <dd>e.g. if 'Output to' is set to <b>data.value</b> then <code>msg.data.value</code> will contain the value of the <i>payload</i></dd>
        <dd>msg.topic will contain the name of the schedule. This simplifies separating out which schedule has triggered</dd>
        <dd>Additional properties are also added to the msg object. Check the debug output (use show complete msg)</dd>
    </dl>

    <h3>Inputs <i>(Advanced Usage)</i></h3>
    <dl class="message-properties">
        <dt><i>payload</i> <span class="property-type">object|Array</span></dt>
        <dd>It is possible to dynamically add, remove & control schedules by injecting a payload object into the node. The format of the payload object (or array of objects) depends on the operation. See below for details.</dd>
        <dd>
            <p><b>Adding one (or more) schedules</b><br>Example...<br>
                <pre>[
  {
    "command": "add",
    "name": "every 6",
    "expression": "*/6 * * * * * *",
    "payload": "hi every 6",
    "type": "str",
    "limit": 3 
  }
]</pre>
                
                <p><i>Details...</i><br>
                    <ul>
                        <li>Multiple schedules can be added if the payload is an array of objects/li>
                        <li>command: (string|required) The operation to perform</li>
                        <li>name: (string|required) This will be used as the topic when the schedule triggers</li>
                        <li>expression: (string|required) A CRON expression, a date, a comma seperated list of dates or an array of dates</li>
                        <li>payload: (any|optional) What to send when schedule triggers</li>
                        <li>type: (string|optional) The payload type (e.g. 'flow', 'global', 'str', 'num', 'bool', 'json', 'bin', 'date' or 'env')</li>
                        <li>limit: (number|optional) Maximum number of times the schedule should trigger</li>
                    </ul>
                </p>
            </p>
            <p><i>Notes...</i><br>
                <ul>
                    <li>This option has no output.</li>
                </ul>
            </p>

            <p><b>Removing, stopping, pausing, starting, a schedule</b><br>Example...<br>
                <pre>{
    "command": "*see details below*",
    "name": "every 6",
}</pre>
                <p><i>Details...</i><br>
                    <ul>
                        <li>command: (string|required) The operation to perform - this can be one of the following...
                            <ul>
                                <li>"status"</li>
                                <li>"remove"</li>
                                <li>"stop"</li>
                                <li>"pause"</li>
                                <li>"start"</li>
                            </ul>
                        </li>
                        <li>name: (string|required) The name of the schedule to affect</li>
                    </ul>
                </p>
                <p><i>Notes...</i><br>
                    <ul>
                        <li>status returns an object with the config and status of the named schedule</li>
                        <li>remove will stop and remove the schedule. This option has no output.</li>
                        <li>stop will stop the schedule specified by <code>name</code> and reset its internal counter. This option has no output.</li>
                        <li>pause will stop the schedule specified by <code>name</code> but will not reset its internal counter. This option has no output.</li>
                        <li>start will (re)start all schedules. Any schedule that reached its limit will start from the begining. Paused schedules will resume. This option has no output.</li>
                    </ul>
                </p>
            </p>                

            <p><b>Status all, remove all, stop all, pause all, start all...</b><br>Example...<br>
                <pre>{
    "command": "*see details below*"
}</pre>
                <p><i>Details...</i><br>
                    <ul>
                        <li>command: (string|required) The operation to perform - this can be one of the following...
                            <ul>
                                <li>"status-all"</li>
                                <li>"remove-all"</li>
                                <li>"stop-all"</li>
                                <li>"pause-all"</li>
                                <li>"start-all"</li>
                            </ul>
                        </li>
                    </ul>
                </p>
                <p><i>Notes...</i><br>
                    <ul>
                        <li>status-all returns an array of all schedules (both those added in the UI and those added dynamically)</li>
                        <li>remove-all will stop and remove all schedules. This option has no output</li>
                        <li>stop-all will stop all schedules and reset internal counters. This option has no output</li>
                        <li>pause-all will stop all schedules but will not reset internal counters. This option has no output</li>
                        <li>start-all will (re)start all schedules. Any schedule that reached its limit will start from the begining. Paused schedules will resume. This option has no output</li>
                    </ul>
                </p>
            </p>  

            <p><b>Describe</b><br>Example...<br>
                <pre>{
    "command": "describe",
    "expression": "0 */5 * * * MON *",
    "timeZone": "Europe/London"
}</pre>

                <p><i>Details...</i><br>
                    Returns an object in payload containing human readable info for the given expression.
                    <ul>
                        <li>command: (string|required) The operation to perform</li>
                        <li>expression: (string|required) The expression to describe</li>
                        <li>timeZone: (string|optional) A timezone to use. Leave blank for system timezone. Alternatively, enter UTC or a timezone in the format of Region/Area (<a target="_blank" href="https://en.wikipedia.org/wiki/List_of_tz_database_time_zones">list</a>) </li>
                    </ul>
                </p>
            </p>                
        </dd>

        <dd>GENERAL NOTES...<br>
        <ul>
            <li>Adding a schedule with the same name as an existing schedule will replace the existing one</li>
            <li>Adding a schedule with property <code>"limit":3</code> will cause that schedule to be stopped after the third trigger. It can be started again by injecting a payload of <code>{"command":"start" "name": "schedule name"}</code></li>
            <li>UI added tasks can be also be updated by using the name specified in the UI</li>
            <li>When a cron-plus node is modified and deployed (or node-red is restarted), dynamic entries are discarded & must be injected again</li>
            <li>When a cron-plus node outputs a msg in response to a command, <code>msg.commandResponse</code> will be <code>true</code> to indicate the message is in response to a command and not a scheduled event</li>
            <li>When a cron-plus node outputs a msg for a cron/sunrise/sunset scheduled event, <code>msg.scheduledEvent</code> will be <code>true</code> to indicate the message is due to a scheduled event and not a control response</li>
        </ul>
        </dd>
    </dl>
    
</script>