
<!--
MIT License

Copyright (c) 2019, 2020, 2021 Steve-Mcl

Permission is hereby granted, free of charge, to any person obtaining a copy
of this software and associated documentation files (the "Software"), to deal
in the Software without restriction, including without limitation the rights
to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the Software is
furnished to do so, subject to the following conditions:

The above copyright notice and this permission notice shall be included in all
copies or substantial portions of the Software.
-->

<script type="text/javascript">
/* global RED, $, jQuery */
/* global cartodb, L */

(function($) {
    "use strict";
    
    /*
        cronBuilder - adapted for cron-plus from https://github.com/juliacscai/jquery-cron-quartz - License...

        The MIT License (MIT)

        Copyright (c) 2016 Julia Cai

        Permission is hereby granted, free of charge, to any person obtaining a copy
        of this software and associated documentation files (the "Software"), to deal
        in the Software without restriction, including without limitation the rights
        to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
        copies of the Software, and to permit persons to whom the Software is
        furnished to do so, subject to the following conditions:

        The above copyright notice and this permission notice shall be included in all
        copies or substantial portions of the Software.

        THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
        IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
        FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
        AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
        LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
        OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
        SOFTWARE.
    */

    var cronInputs = {
        period: '<div class="cron-select-period"><label></label><select class="cron-period-select"></select></div>',
        startTime: '<div class="cron-input cron-start-time">Start time <select class="cron-clock-hour"></select>:<select class="cron-clock-minute"></select></div>',
        container: '<div class="cron-input"></div>',
        minutes: {
            tag: 'cron-minutes',
            inputs: [ '<p>Every <select class="cron-minutes-select"></select> minutes(s)</p>' ]
        },
        hourly: {
            tag: 'cron-hourly',
            inputs: [ '<p><input type="radio" name="hourlyType" value="every"> Every <select class="cron-hourly-select"></select> hour(s)</p>',
                '<p><input type="radio" name="hourlyType" value="clock"> Every day at <select class="cron-hourly-hour"></select>:<select class="cron-hourly-minute"></select></p>' ]
        },
        daily: {
            tag: 'cron-daily',
            inputs: [ '<p><input type="radio" name="dailyType" value="every"> Every <select class="cron-daily-select"></select> day(s)</p>',
                '<p><input type="radio" name="dailyType" value="clock"> Every week day</p>' ]
        },
        weekly: {
            tag: 'cron-weekly',
            inputs: [ '<p><input type="checkbox" name="dayOfWeekMon"> Monday  <input type="checkbox" name="dayOfWeekTue"> Tuesday  ' + 
                '<input type="checkbox" name="dayOfWeekWed"> Wednesday  <input type="checkbox" name="dayOfWeekThu"> Thursday</p>', 
                '<p><input type="checkbox" name="dayOfWeekFri"> Friday  <input type="checkbox" name="dayOfWeekSat"> Saturday  ' + 
                '<input type="checkbox" name="dayOfWeekSun"> Sunday</p>' ]
        },
        monthly: {
            tag: 'cron-monthly',
            inputs: [ '<p><input type="radio" name="monthlyType" value="byDay"> Day <select class="cron-monthly-day"></select> of every <select class="cron-monthly-month"></select> month(s)</p>',
                '<p><input type="radio" name="monthlyType" value="byWeek"> The <select class="cron-monthly-nth-day"></select> ' + 
                '<select class="cron-monthly-day-of-week"></select> of every <select class="cron-monthly-month-by-week"></select> month(s)</p>']
        },
        yearly: {
            tag: 'cron-yearly',
            inputs: [ '<p><input type="radio" name="yearlyType" value="byDay"> Every <select class="cron-yearly-month"></select> <select class="cron-yearly-day"></select></p>',
                '<p><input type="radio" name="yearlyType" value="byWeek"> The <select class="cron-yearly-nth-day"></select> ' + 
                '<select class="cron-yearly-day-of-week"></select> of <select class="cron-yearly-month-by-week"></select></p>']
        }
    };

    var periodOpts = arrayToOptions(["Minutes", "Hourly", "Daily", "Weekly", "Monthly", "Yearly"]);
    var minuteOpts = rangeToOptions(1, 59);
    var hourOpts = rangeToOptions(1, 24);
    var dayOpts = rangeToOptions(1, 31);
    var minuteClockOpts = rangeToOptions(0, 59, true);
    var hourClockOpts = rangeToOptions(0, 23, true);
    var dayInMonthOpts = rangeToOptions(1, 31);
    var monthOpts = arrayToOptions(["January", "February", "March", "April", "May", "June", "July", "August", "September", "October", "November", "December"],
                                    [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12]);
    var monthNumOpts = rangeToOptions(1, 12);
    var nthWeekOpts = arrayToOptions(["First", "Second", "Third", "Forth", "Last"], [1, 2, 3, 4, "L"]);
    var dayOfWeekOpts = arrayToOptions(["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"], ["MON", "TUE", "WED", "THU", "FRI", "SAT", "SUN"]);
    
    
    // Convert an array of values to options to append to select input
    function arrayToOptions(opts, values) {
        var inputOpts = '';
        for (var i = 0; i < opts.length; i++) {
            var value = opts[i];
            if(values != null) value = values[i];
            inputOpts += "<option value='" + value + "'>" + opts[i] + "</option>\n";
            
        }
        return inputOpts;
    }
    
    // Convert an integer range to options to append to select input
    function rangeToOptions(start, end, isClock) {
        var inputOpts = '', label;
        for (var i = start; i <= end; i++) {
            if(isClock && i < 10) label = "0" + i;
            else label = i;
            inputOpts += "<option value='" + i + "'>" + label + "</option>\n";
        }
        return inputOpts;
    }
    
    // Add input elements to UI as defined in cronInputs
    function addInputElements($baseEl, inputObj, onFinish) {
        $(cronInputs.container).addClass(inputObj.tag).appendTo($baseEl);
        $baseEl.children("." + inputObj.tag).append(inputObj.inputs);
        if(typeof onFinish === "function") onFinish();
    }
    
    var eventHandlers = {
        periodSelect: function() {
            var period = ($(this).val());
            var $selector = $(this).parent();
            $selector.siblings('div.cron-input').hide();
            $selector.siblings().find("select option").removeAttr("selected");
            $selector.siblings().find("select option:first").attr("selected", "selected");
            $selector.siblings('div.cron-start-time').show();
            $selector.siblings('div.cron-start-time').children("select.cron-clock-hour").val('12');
            switch(period) {
                case 'Minutes':
                    $selector.siblings('div.cron-minutes')
                        .show()
                        .find("select.cron-minutes-select").val('1');
                    $selector.siblings('div.cron-start-time').hide();
                    break;
                case 'Hourly':
                    var $hourlyEl = $selector.siblings('div.cron-hourly');
                    $hourlyEl.show()
                        .find("input[name=hourlyType][value=every]").prop('checked', true);
                    $hourlyEl.find("select.cron-hourly-hour").val('12');
                    $selector.siblings('div.cron-start-time').hide();
                    break;
                case 'Daily':
                    var $dailyEl = $selector.siblings('div.cron-daily');
                    $dailyEl.show()
                        .find("input[name=dailyType][value=every]").prop('checked', true);
                    break;
                case 'Weekly':
                    $selector.siblings('div.cron-weekly')
                        .show()
                        .find("input[type=checkbox]").prop('checked', false);
                    break;
                case 'Monthly':
                    var $monthlyEl = $selector.siblings('div.cron-monthly');
                    $monthlyEl.show()
                        .find("input[name=monthlyType][value=byDay]").prop('checked', true);
                    break;
                case 'Yearly':
                    var $yearlyEl = $selector.siblings('div.cron-yearly');
                    $yearlyEl.show()
                        .find("input[name=yearlyType][value=byDay]").prop('checked', true);
                    break;                    
            } 
        }
    };
    
    // Public functions
    $.cronBuilder = function(el, options) {
        var base = this;
        
        // Access to jQuery and DOM versions of element
        base.$el = $(el);
        base.el = el;
        
        // Reverse reference to the DOM object
        base.$el.data('cronBuilder', base);
        
        // Initialization
        base.init = function() {
            base.options = $.extend({}, $.cronBuilder.defaultOptions, options);
        
            
            base.$el.append(cronInputs.period);
            base.$el.find("div.cron-select-period label").text(base.options.selectorLabel);
            base.$el.find("select.cron-period-select")
                .append(periodOpts)
                .bind("change", eventHandlers.periodSelect);
            
            addInputElements(base.$el, cronInputs.minutes, function() {
                base.$el.find("select.cron-minutes-select").append(minuteOpts);
            });

            addInputElements(base.$el, cronInputs.hourly, function() {
                base.$el.find("select.cron-hourly-select").append(hourOpts); 
                base.$el.find("select.cron-hourly-hour").append(hourClockOpts);
                base.$el.find("select.cron-hourly-minute").append(minuteClockOpts);
            });
            
            addInputElements(base.$el, cronInputs.daily, function() {
                base.$el.find("select.cron-daily-select").append(dayOpts); 
            });
            
            addInputElements(base.$el, cronInputs.weekly);
            
            addInputElements(base.$el, cronInputs.monthly, function() {
                base.$el.find("select.cron-monthly-day").append(dayInMonthOpts); 
                base.$el.find("select.cron-monthly-month").append(monthNumOpts); 
                base.$el.find("select.cron-monthly-nth-day").append(nthWeekOpts); 
                base.$el.find("select.cron-monthly-day-of-week").append(dayOfWeekOpts); 
                base.$el.find("select.cron-monthly-month-by-week").append(monthNumOpts);
            });

            addInputElements(base.$el, cronInputs.yearly, function() {
                base.$el.find("select.cron-yearly-month").append(monthOpts); 
                base.$el.find("select.cron-yearly-day").append(dayInMonthOpts); 
                base.$el.find("select.cron-yearly-nth-day").append(nthWeekOpts); 
                base.$el.find("select.cron-yearly-day-of-week").append(dayOfWeekOpts); 
                base.$el.find("select.cron-yearly-month-by-week").append(monthOpts); 
            });
            
            
            base.$el.append(cronInputs.startTime);
            base.$el.find("select.cron-clock-hour").append(hourClockOpts);
            base.$el.find("select.cron-clock-minute").append(minuteClockOpts);
            
            if(typeof base.options.onChange === "function") {
                base.$el.find("select, input").change(function() {
                    base.options.onChange(base.getExpression());
                });
            }

            base.$el.find("select.cron-period-select")
                .triggerHandler("change");
            
        };
        
        base.getExpression = function() {
            //var b = c.data("block");
            var sec = 0; // ignoring seconds by default
            var year = "*"; // every year by default
            var dow = "?";
            var month = "*", dom = "*";
            var min = base.$el.find("select.cron-clock-minute").val();
            var hour = base.$el.find("select.cron-clock-hour").val();
            var period = base.$el.find("select.cron-period-select").val();
            switch (period) {
                case 'Minutes':
                    {
                        let $selector = base.$el.find("div.cron-minutes");
                        let nmin = $selector.find("select.cron-minutes-select").val();
                        if(nmin > 1) min = "0/" + nmin;
                        else min = "*";
                        hour = "*";
                    }
                    break;
                    
                case 'Hourly':
                    {
                        let $selector = base.$el.find("div.cron-hourly");
                        if($selector.find("input[name=hourlyType][value=every]").is(":checked")){
                            min = 0;
                            hour = "*";
                            var nhour = $selector.find("select.cron-hourly-select").val();
                            if(nhour > 1) hour = "0/" + nhour;
                        } else {
                            min = $selector.find("select.cron-hourly-minute").val();
                            hour = $selector.find("select.cron-hourly-hour").val();
                        }
                    }
                    break;
    
                case 'Daily':
                    {
                        let $selector = base.$el.find("div.cron-daily");
                        if($selector.find("input[name=dailyType][value=every]").is(":checked")){
                            var ndom = $selector.find("select.cron-daily-select").val();
                            if(ndom > 1) dom = "1/" + ndom;
                        } else {
                            dom = "?";
                            dow = "MON-FRI";
                        }
                    }
                    break;
    
                case 'Weekly':
                    {
                        let $selector = base.$el.find("div.cron-weekly");
                        let ndow = [];
                        if($selector.find("input[name=dayOfWeekMon]").is(":checked"))
                            ndow.push("MON");
                        if($selector.find("input[name=dayOfWeekTue]").is(":checked"))
                            ndow.push("TUE");
                        if($selector.find("input[name=dayOfWeekWed]").is(":checked"))
                            ndow.push("WED");
                        if($selector.find("input[name=dayOfWeekThu]").is(":checked"))
                            ndow.push("THU");
                        if($selector.find("input[name=dayOfWeekFri]").is(":checked"))
                            ndow.push("FRI");
                        if($selector.find("input[name=dayOfWeekSat]").is(":checked"))
                            ndow.push("SAT");
                        if($selector.find("input[name=dayOfWeekSun]").is(":checked"))
                            ndow.push("SUN");
                        dow = "*";
                        dom = "?";
                        if(ndow.length < 7 && ndow.length > 0) dow = ndow.join(",");
                    }
                    break;
    
                case 'Monthly':
                    {
                        let $selector = base.$el.find("div.cron-monthly");
                        let nmonth;
                        let mnd;
                        if($selector.find("input[name=monthlyType][value=byDay]").is(":checked")){
                            month = "*";
                            nmonth = $selector.find("select.cron-monthly-month").val();
                            dom = $selector.find("select.cron-monthly-day").val();
                            dow = "?";
                        } else {
                            mnd = $selector.find("select.cron-monthly-nth-day").val();
                            dow = $selector.find("select.cron-monthly-day-of-week").val()
                                + (mnd == "L" ? "L" : "#" + mnd);
                            nmonth = $selector.find("select.cron-monthly-month-by-week").val();
                            dom = "?";
                        }
                        if(nmonth > 1) month = "1/" + nmonth;
                    }
                    break;
    
                case 'Yearly':
                    {
                        let $selector = base.$el.find("div.cron-yearly");
                        let ynd;
                        if($selector.find("input[name=yearlyType][value=byDay]").is(":checked")){
                            dom = $selector.find("select.cron-yearly-day").val();
                            month = $selector.find("select.cron-yearly-month").val();
                            dow = "?";
                        } else {
                            ynd = $selector.find("select.cron-yearly-nth-day").val();
                            dow = $selector.find("select.cron-yearly-day-of-week").val()
                                + (ynd == "L" ? "L" : "#" + ynd);
                            month = $selector.find("select.cron-yearly-month-by-week").val();
                            dom = "?";
                        }
                    }
                    break;
    
                default:
                    break;
            }
            return [sec, min, hour, dom, month, dow, year].join(" ");            
        };
        
        base.init();
    };
    
    // Plugin default options
    $.cronBuilder.defaultOptions = {
        selectorLabel: "Select period: "
    };    

    // Plugin definition 
    $.fn.cronBuilder = function(options) {
        return this.each(function(){
            (new $.cronBuilder(this, options));
        });
    };

}( jQuery ));


(function(){

    var debug = false;
    var map, mapPopup, selectedLocation, selectedLocationInput;

    var filesAdded = []; //list of files already added 
    function checkLoadJsCssFile(filename, filetype, callback){
        if (filesAdded.indexOf(filename) === -1){
            loadJsCssFile(filename, filetype, function(){
                filesAdded.push(filename);
                if(callback) callback();
            });
        } else {
            if (callback) callback();
        }
    }

    function loadJsCssFile(filename, filetype, callback){
        var fileRef;
        if (filetype == "js"){ //if filename is a external JavaScript file
            fileRef = document.createElement('script');
            fileRef.setAttribute("type", "text/javascript");
            fileRef.setAttribute("src", filename);
        }
        else if (filetype == "css"){ //if filename is an external CSS file
            fileRef = document.createElement("link");
            fileRef.setAttribute("rel", "stylesheet");
            fileRef.setAttribute("type", "text/css");
            fileRef.setAttribute("href", filename);
        }
        if (typeof fileRef != "undefined")
            document.getElementsByTagName("head")[0].appendChild(fileRef);

        fileRef.onload = function() {
            if (callback) callback();
        };
    }
  
    function safeFloat(value, def) {
        if ((undefined === value) || (null === value)) {
            return def || 0.0;
        }
        try {
            value = parseFloat(value);
        } catch (e) {
            value = def || 0.0;
        }
        if (isNaN(value)) {
            return def || 0.0;
        }
        return value;
    }

    function isCronLike(expression){
        if(typeof expression !== "string") return false;
        if(expression.indexOf("*") >= 0) return true;
        let cleaned = expression.replace(/\s\s+/g, ' ');
        let spaces = cleaned.split(" ");
        return spaces.length >= 4 && spaces.length <= 6 ; 
    }

    function isDateSequenceLike(expression){
        try {
            if(typeof expression !== "string") return false;
            if(expression.indexOf("*") >= 0) return false;
            if(expression.indexOf("#") >= 0) return false;
            if(expression.indexOf("?") >= 0) return false;
            var cleaned = expression.replace(/\s\s+/g, ' ');
            var parts = cleaned.split(",");
            for (var index = 0; index < parts.length; index++) {
                var part = parts[index];
                if(parseInt(part) == part) part = parseInt(part);
                var d = new Date(part);
                var isDate = (d instanceof Date && !isNaN(d.valueOf()));
                if(!isDate) return false;
            }
            return true;
        } catch (error) {
            return false;
        }
    }

    function showSidebarHelpPanel(){ 
        if(RED.sidebar.help) {
            RED.sidebar.help.show();//  >= V1.1.0
        } else {
            RED.sidebar.show("info");// <  V1.1.0
        }
    }
    function showCronHelp(){
        showSidebarHelpPanel();
        $("#cron-plus-expression-info").get(0).scrollIntoView();
    }
    function showSolarHelp(){
        showSidebarHelpPanel();
        $("#cron-plus-solar-events-info").get(0).scrollIntoView();
    }
    function createMap(srcInput) {
        $(".cron-plus-map-loading").hide();
        if(!window.L || navigator.onLine === false){
            $(".cron-plus-map-not-loaded").show();
            $("#cron-plus-map").hide();
            return;
        }
        $("#cron-plus-map").show();
        $(".cron-plus-map-not-loaded").hide();
        var lat, lon;
        var latlon = srcInput.val();
        if(latlon){
            var splitChar = " ";
            if(latlon.includes(",")) splitChar = ",";
            var arrLatlon = latlon.split(splitChar);
            if(arrLatlon.length >= 2){
                lat = arrLatlon[0];
                lon = arrLatlon[1];
            }
        }
        if(debug) console.log("createMap", lat, lon);
        var zoom = 3;//by default, zoomed out
        var showPopupOnOpen = false;
        if (lat != undefined && lon != undefined) {
            showPopupOnOpen = true;
            zoom = 5;//if location is set, zoom in a bit
        }
        lat = safeFloat(lat, 50.0);
        lon = safeFloat(lon, 0.0);
        if(debug) console.log("lat/lon", lat, lon);
        selectedLocation = window.L.latLng(lat, lon);
        if(debug) console.log("selectedLocation", selectedLocation.lat, selectedLocation.lng);

        // create leaflet map
        map = window.L.map('cron-plus-map', {
            zoomControl: true,
            center: selectedLocation, //[selectedLocation.lat,selectedLocation.lng],
            zoom: zoom
        });
        mapPopup = window.L.popup();

        map.on('click', function (e) {
            
            if(debug) console.log(e);
            var normaliseLat = function(x) {
                while (x > 90.0 || x < -90.0) {
                    if (x > 90.0) {   x = -(90.0 - (x - 90)); }
                    if (x < -90.0) {   x = (90.0 - ((-x) - 90)); }
                }
                return x;
            };
            var normaliseLng = function(x) {
                while (x > 180.0 || x < -180.0) {
                    if (x > 180.0) {   x = -(180.0 - (x - 180)); }
                    if (x < -180.0) {   x = (180.0 - ((-x) - 180)); }
                }
                return x;
            };
            selectedLocation = {};
            selectedLocation.lat = normaliseLat(e.latlng.lat);
            selectedLocation.lng = normaliseLng(e.latlng.lng);
            var content =
            '<div><span>Lat:</span> <span>' + selectedLocation.lat + '</span></div>' +
                '<div><span>Lon:</span> <span>' + selectedLocation.lng + '</span></div>';
            showMapPopup(content, e.latlng.lat, e.latlng.lng, map);
        });


        function showMapPopup(content, lat, lon, map) {
            mapPopup
                .setLatLng([lat, lon])
                .setContent(content)
                .openOn(map);
        }


        // add a base layer
        var tileUrl = "https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png";
        var layer = L.tileLayer(tileUrl, {});
        layer.addTo(map);
        // add cartodb layer with one sublayer
        cartodb.createLayer(map, {
            user_name: 'node-red',
            type: 'namedmap',
            options: {
                named_map: {
                    name: 'node-red@cronplus',
                    params: {
                        "color": "#5CA2D1"
                    },
                    layers: [{}]
                }
            }
        })
            .addTo(map)
            .done(function (layer) {
                layer.setInteraction(true);
                if (showPopupOnOpen) {
                    showMapPopup(selectedLocation.lat, selectedLocation.lng, map);
                }

                // eslint-disable-next-line no-unused-vars
                layer.on('featureClick', function (e, latlng, pos, data, layer) {
                    if(debug) console.log("click", latlng, data);
                });
                $( "#cron-plus-map-dialog" ).dialog("option", "position", { my: "center", at: "center", of: window });
            });

    }


    function updateEditorLayout(){
        if(debug) console.log("cronplus-updateEditorLayout");
        var dlg = $("#dialog-form");
        var height = dlg.height() - 5;
        var expandRow = dlg.find('.form-row-auto-height');
        if(expandRow && expandRow.length){
            let childRows = dlg.find('.form-row:not(.form-row-auto-height)');
            for (var i = 0; i < childRows.size(); i++) {
                var cr = $(childRows[i]);
                if(cr.is(":visible"))
                    height -= cr.outerHeight(true);
            }
            expandRow.css("height", height + "px");
        } 
    }

    function JSONtoTable(data, header, placeholder, options) {
        if(debug) console.log("JSONtoTable");
        options = options || {};
        if(!data || !data.length){
            $('<div class="ui-dialog-title"/>' + (options.emptyMessage || 'no data') + '<div>').appendTo(placeholder);
            return;
        }
        var table = $('<table/>');
        if(options.width) table.width(options.width);
        if(options.height) table.width(options.height);
        if(options.class) table.addClass(options.class);
        
        //TH Loop
        var rows = '<tr>';
        $.each(header, function (header_key, header_value) {
            rows += '<th>' + header_value.header + '</th>';
        });
        rows += '</tr>';
        //TR loop
        $.each(data, function (key, value) {
            rows += '<tr>';
            //TD loop
            $.each(header, function (item_key, header_value) {
                rows += '<td>' + value[header_value.key] + '</td>';
            });
            rows += '</tr>';
        });
 
        table.append(rows);
        $(placeholder).append(table);
    }

    $.widget("custom.combobox", {
        _create: function () {
            var that = this;
            this.input = this.element;
            this.input.addClass("red-ui-typedInput-input");
            this.elementDiv = this.input.wrap("<div>").parent().addClass('red-ui-typedInput-input-wrap');
            this.uiSelect = this.elementDiv.wrap( "<div>" ).parent();
            var attrStyle = this.element.attr('style');            
            this.uiWidth = this.input.outerWidth();            
            this.input.css("paddingLeft", 5);
            
            var m;
            if ((m = /width\s*:\s*(calc\s*\(.*\)|\d+(%|px))/i.exec(attrStyle)) !== null) {
                this.input.css('width', 'calc(100% - 4px)');
                this.uiSelect.width(m[1]);
                this.uiWidth = null;
            } else {
                this.uiSelect.width(this.uiWidth);
            }

            ["Right", "Left"].forEach(function(d) {
                var m = that.element.css("margin" + d);
                that.uiSelect.css("margin" + d, m);
                that.input.css("margin" + d, 1);
            });

            this.uiSelect.addClass("red-ui-typedInput-container");

            this.input.on('change', function() {
                that.validate();
            });

            this.button = $('<button tabindex="0" class="red-ui-typedInput-option-expand" style="display:inline-block;width: 20px"><span class="red-ui-typedInput-option-caret"><i class="red-ui-typedInput-icon fa fa-caret-down"></i></span></button>').appendTo(this.uiSelect);
            // this.buttonLabel = $('<span class="red-ui-typedInput-option-label"></span>').prependTo(this.button);
            this.button.on("click", function(event) {
                event.preventDefault();
                event.stopPropagation();
                that._showDropdownMenu();
            }).on('keydown', function(evt) {
                if (evt.keyCode === 40 /*down*/) {
                    that._showDropdownMenu();
                }
                evt.stopPropagation();
            }).on('blur', function() {
                that.uiSelect.removeClass('red-ui-typedInput-focus');
            }).on('focus', function() {
                that.uiSelect.addClass('red-ui-typedInput-focus');
            });
            this.menu = this._createMenu(this.options.menu);
        },
        _createMenu: function(options) {
            if(debug) console.log("combobox -> _createMenu  options:", options);
            var that = this;
            this.disarmClick = false;
            options = options || {};
            var menu = $("<div>").addClass("red-ui-typedInput-options red-ui-editor-dialog");
            var callback = options.options ? options.options.callback : null;
            var beforeSelect = options.options ? options.options.beforeSelect : null;
            var menuItems = options.menu || [];
            menuItems.forEach(function(opt) {
                if (typeof opt === 'string') {
                    opt = { value: opt, label: opt };
                }
                var op = $('<a href="#"></a>').attr("value", opt.value).appendTo(menu);
                if (opt.label) {
                    op.text(opt.label);
                }
                if (opt.title) {
                    op.prop('title', opt.title);
                }
                if (opt.icon) {
                    if (opt.icon.indexOf("<") === 0) {
                        $(opt.icon).prependTo(op);
                    } else if (opt.icon.indexOf("/") !== -1) {
                        $('<img>', { src: opt.icon, style: "margin-right: 4px; height: 18px;" }).prependTo(op);
                    } else {
                        $('<i>', { class: "red-ui-typedInput-icon " + opt.icon }).prependTo(op);
                    }
                } else {
                    op.css({ paddingLeft: "18px" });
                }
                if (!opt.icon && !opt.label) {
                    op.text(opt.value);
                }

                op.on("click", function(event) {
                    event.preventDefault();
                    event.stopPropagation();
                    var cancel = false;
                    if(beforeSelect) {
                        cancel = beforeSelect(opt);
                    }
                    if(!cancel) {
                        if(callback){
                            that.value(callback(opt.value));
                        } else {
                            that.value(opt.value);
                        }
                    }
                    
                    that._hideMenu(menu);
                });
            });
            menu.css({ display: "none" });
            menu.appendTo(document.body);

            menu.on('keydown', function(evt) {
                if (evt.keyCode === 40/*down*/) {
                    evt.preventDefault();
                    $(this).children(":focus").next().trigger("focus");
                } else if (evt.keyCode === 38/*up*/) {
                    evt.preventDefault();
                    $(this).children(":focus").prev().trigger("focus");
                } else if (evt.keyCode === 27/*escape*/) {
                    evt.preventDefault();
                    that._hideMenu(menu);
                }
                evt.stopPropagation();
            });
            return menu;

        },
        _showDropdownMenu: function() {
            if (this.menu) {
                this.menu.css({
                    minWidth: this.uiSelect.width()
                });
                this._showMenu(this.menu, this.button);
            }
        },
        _hideMenu: function(menu) {
            $(document).off("mousedown.red-ui-typedInput-close-property-select");
            menu.hide();
            menu.css({
                height: "auto"
            });
            this.input.trigger("focus");
            //this.button.trigger("focus");

        },
        _showMenu: function(menu, relativeTo) {
            if (this.disarmClick) {
                this.disarmClick = false;
                return;
            }
            var that = this;
            //var pos = relativeTo.offset();
            //var height = relativeTo.height();
            var pos = this.uiSelect.offset();
            var height = this.uiSelect.height();
            var menuHeight = menu.height();
            var menuWidth = menu.width();
            var top = (height + pos.top);
            var left = pos.left;
            if (left + menuWidth > $(window).width()) {
                left -= (left + menuWidth) - $(window).width() + 5;
            }
            if (top + menuHeight > $(window).height()) {
                top -= (top + menuHeight) - $(window).height() + 5;
            }
            if (top < 0) {
                menu.height(menuHeight + top);
                top = 0;
            }
            menu.css({
                top: top + "px",
                left: (left) + "px",
            });
            menu.slideDown(100);
            this._delay(function() {
                that.uiSelect.addClass('red-ui-typedInput-focus');
                $(document).on("mousedown.red-ui-typedInput-close-property-select", function(event) {
                    if(!$(event.target).closest(menu).length) {
                        that._hideMenu(menu);
                    }
                    if ($(event.target).closest(relativeTo).length) {
                        that.disarmClick = true;
                        event.preventDefault();
                    }
                });
            });
        },
        _destroy: function () {
            if (this.menu) {
                this.menu.remove();
            }
            this.button.remove();
            this.element.unwrap();
            this.element.unwrap();
            this.input.removeClass("red-ui-typedInput-input");
        },
        value: function(value) {
            var that = this;
            if (!arguments.length) {
                return that.input.val();
            } else {
                that.input.val(value);
                that.validate();
            }
        },
        validate: function() {
            var result;
            var value = this.value();
            var val = this.options.validate;// || this.validate;
            if (!val || typeof val !== 'function') {
                result = true;
            }  else {
                result = val(value);
            }
            if (result) {
                this.uiSelect.removeClass('input-error');
            } else {
                this.uiSelect.addClass('input-error');
            }
            return result;
        },
        showMenu: function(){
            this.button.show();
        },
        hideMenu: function(){
            this.button.hide();
        },
        show: function() {
            this.uiSelect.show();
        },
        hide: function() {
            this.uiSelect.hide();
        }
    });


    // checkLoadJsCssFile("https://cdnjs.cloudflare.com/ajax/libs/awesomplete/1.1.5/awesomplete.min.js","js")

    RED.nodes.registerType('cronplus', {
        category: "input",
        icon: "timer.png",
        color: "#a6bbcf",
        inputs: 1,
        outputs: 1,
        defaults: {
            name: { value: "" },
            //FUTURE config: { type: "CRON-PLUS Config" },
            outputField: { value: "payload" },
            timeZone: { value: "" },
            persistDynamic: { value: false },
            commandResponseMsgOutput: { value: "output1" },
            outputs: { value: 1 },
            options: {
                value: [{ payload: '', topic: '', expression: '' }], 
                validate: function(value) { 
                    var dupCheck = {};
                    // $("#node-input-option-container > li:nth-child(" + (i+1) + ")  .node-input-option-name").removeClass("input-error");
                    // $("#node-input-option-container > li:nth-child(" + (i+1) + ")  .node-input-option-topic").removeClass("input-error");
                    // $("#node-input-option-container > li:nth-child(" + (i+1) + ")  .node-input-option-payload").removeClass("input-error");
                    // $("#node-input-option-container > li:nth-child(" + (i+1) + ")  .node-input-option-expressionType").removeClass("input-error");
                    // $("#node-input-option-container > li:nth-child(" + (i+1) + ")  .node-input-option-expression").removeClass("input-error");
                    if (value.length) {
                        for (var i = 0; i < value.length; i++) {
                            if(!value[i].name && value[i].topic) {
                                value[i].name = value[i].topic;
                            }
                            if(!value[i].name) {
                                console.warn("cron-plus: validation error - schedule name missing");
                                $("#node-input-option-container > li:nth-child(" + (i + 1) + ")  .node-input-option-name").addClass("input-error");
                                return false;
                            } else {
                                $("#node-input-option-container > li:nth-child(" + (i + 1) + ")  .node-input-option-name").removeClass("input-error");
                            }                 
                            if(dupCheck[value[i].name]) {
                                console.warn("cron-plus: validation error - duplicate schedule named '" + value[i].name + "'");
                                $("#node-input-option-container > li:nth-child(" + (i + 1) + ")  .node-input-option-name").addClass("input-error");
                                return false;
                            } else {
                                $("#node-input-option-container > li:nth-child(" + (i + 1) + ")  .node-input-option-name").removeClass("input-error");
                            }
                            dupCheck[value[i].name] = true;
                            if (!value[i].expressionType || value[i].expressionType === "cron") {
                                if (!value[i].expression) {
                                    console.warn("cron-plus: validation error - expression missing");
                                    // $("#node-input-option-container > li:nth-child(" + (i+1) + ")  .node-input-option-expressionType").addClass("input-error");
                                    return false;
                                }
                            } else if(value[i].expressionType === "solar" ) {
                                if (value[i].solarType != "all" && value[i].solarType != "selected") {
                                    console.warn("cron-plus: validation error - solarType is not 'all' or 'selected'");
                                    // $("#node-input-option-container > li:nth-child(" + (i+1) + ")  .node-input-option-solarType").addClass("input-error");
                                    return false;
                                }
                                if (value[i].solarType == "selected" && !value[i].solarEvents) {
                                    console.warn("cron-plus: validation error - solarEvents missing");
                                    return false;
                                }
                            }
                        }
                    }
                    return true;
                },
                required: true
            },
        },
        label: function () {
            return this.name || "cron-plus";
        },
        outputLabels: function(index) {
            var node = this;
            var fanOut = node.commandResponseMsgOutput === "fanOut" ? true : false;
            var hasCommandOutputPin = (node.commandResponseMsgOutput === "output2" || fanOut) ? true : false;
            var optionCount = node.options ? node.options.length : 0;
            var dynOutputPinIndex = 0;
            var cmdOutputPinIndex = hasCommandOutputPin ? 1 : 0;
            if (fanOut) {
                dynOutputPinIndex = optionCount;
                cmdOutputPinIndex = optionCount + 1;
            }
            if (!fanOut && !hasCommandOutputPin) return "All messages and events";
            if (!fanOut && hasCommandOutputPin && index == 0) return "Static and Dynamic schedule messages";
            if (index == cmdOutputPinIndex) return "Command responses only";
            if (index == dynOutputPinIndex) return "Dynamic schedules only";
            var item = node.options && node.options[index];
            if (item) return item.name + " (" + item.expressionType + ")"; 
        },
        oneditprepare: function () {
            var node = this;
            var dupCheck = {};
            node.commandResponseMsgOutput = ["output1", "output2", "fanOut"].indexOf(node.commandResponseMsgOutput) >= 0 ? node.commandResponseMsgOutput : "output1";
            // $( "#node-input-commandResponseMsgOutput" ).on("change", function() {
            //     var $tip = $("#cron-plus-outputs-tip");
            //     var choice = $(this).val();
            //     switch (choice) {
            //         case "output2":
            //             $tip.val("Send schedule events to output 1, command responses to output 2");
            //             break;
            //         case "fanOut":
            //             $tip.val("Separate outputs for each static schedule, 2nd last output is for dynamic schedules, last output for command responses");
            //             break;
                
            //         default:
            //             $tip.val("All events go to output 1");
            //             break;
            //     }
            // })
            $( "#node-input-commandResponseMsgOutput" ).val(node.commandResponseMsgOutput);

            var getIdealDialogHeight = function(){
                return Math.min(800, ($(document).height() < 600) ? $(document).width() - 30 : $(document).height() - 100);
            };

            //create map popup dialog
            $( "#cron-plus-map-dialog" ).dialog({
                classes: {
                    "ui-dialog-content": "cron-plus-map-dialog-content"
                },
                autoOpen: false,
                height: getIdealDialogHeight(),
                width: "90%",
                minWidth: 300,
                maxWidth: 1000,
                modal: true,
                buttons: {
                    Cancel: function() {
                        $( "#cron-plus-map-dialog" ).dialog( "close" );
                    },
                    "OK": function(){
                        $( "#cron-plus-map-dialog" ).dialog( "close" );
                        if(selectedLocation) {
                            if(selectedLocationInput){
                                selectedLocationInput.val(selectedLocation.lat + " " + selectedLocation.lng);
                            }
                            selectedLocationInput.focus();
                            selectedLocationInput.change();
                        }
                    }
                },
                show: {
                    effect: "blind",
                    duration: 500
                },
                // eslint-disable-next-line no-unused-vars
                open: function(event) {
                    $(this).css('padding', '0px 0px 0px 0px');
                    $('.ui-dialog-buttonpane').find('button:contains("OK")').addClass('primary');
                    $( "#cron-plus-map-dialog" ).dialog( "option", "height", getIdealDialogHeight() );
                    $("#cron-plus-dynamic-nodes-dialog").dialog("option", "position", { my: "center", at: "center", of: window });
                },
                hide: {
                    effect: "explode",
                    duration: 500
                },
                // eslint-disable-next-line no-unused-vars
                close: function( event, ui ) {
                    if(debug) console.log("destroying map");
                    if(map) map.remove();
                }
            });

            //create the popup dialog for the cron builder
            $( "#cron-plus-expression-builder-dialog" ).dialog({
                autoOpen: false,
                height: 300,
                width: 480,
                minWidth: 400,
                maxWidth: 600,
                modal: true,
                buttons: {
                    Cancel: function() {
                        $( "#cron-plus-expression-builder-dialog" ).dialog( "close" );
                    },
                    "OK": function(){
                        var val = $('#cron-plus-expression-builder').data('cronBuilder').getExpression();
                        var expressionField = $( "#cron-plus-expression-builder-dialog" ).data("opener");
                        if(expressionField && expressionField.length) {
                            expressionField.combobox("value", val || "");
                            // expressionField.focus();
                        }
                        $( "#cron-plus-expression-builder-dialog" ).dialog( "close" );
                    }
                },
                show: {
                    effect: "blind",
                    duration: 500
                },
                // eslint-disable-next-line no-unused-vars
                open: function(event) {
                    // $(this).css('padding', '0px 0px 0px 0px');
                    $('.ui-dialog-buttonpane').find('button:contains("OK")').addClass('primary');
                    $("#cron-plus-expression-builder .cron-period-select").change();//cause cronBuilder UI to update
                },
                close: function() {
                    var expressionField = $( "#cron-plus-expression-builder-dialog" ).data("opener");
                    if(expressionField && expressionField.data("customCombobox") && expressionField.data("customCombobox").input) {
                        // expressionField.combobox("value", val || "");
                        expressionField.data("customCombobox").input.focus();
                    }
                },
                hide: {
                    effect: "explode",
                    duration: 500
                }
            });
            
            //build cron builder
            if(!$('#cron-plus-expression-builder').data('cronBuilder')) {
                $( "#cron-plus-expression-builder" ).cronBuilder();
            }

            function drawDynamicSchedulesTable(nodeId, table, spinner, callback){
                var $table = $( table );                           
                var $spinner = $( spinner );                 
                $table.hide();
                $spinner.show();
                $table.empty();
                $.ajax({
                    url: "cronplus/" + nodeId + "/getDynamic",
                    // url: 'cronplus/tz',
                    type: 'POST',
                    datatype: 'json'
                })
                .done(function (response) {
                    if(debug) console.log("cronplus/" + nodeId + "/getDynamic => response:", response);
                    var titles = [
                        { "key": "item", "header": "Item" },
                        { "key": "expressionType", "header": "Type" },
                        // {"key":"name", "header":"Name"},
                        // {"key":"topic", "header":"Topic"},
                        // {"key":"payloadType", "header":"Payload Type"},
                        // {"key":"payload", "header":"Payload"},
                        { "key": "info", "header": "Info" },
                        { "key": "details", "header": "Details" },
                    ];
                    //tidy up date for display
                    var tableData = response.map(function(e, i){
                        e.item = i + 1;
                        if(e.type){
                            e.payloadType == e.type;
                        }
                        if(e.payloadType == "default") e.payload = null;
                        var payload, payloadTT = "";
                        if(e.payload && isObject(e.payload)){
                            try {
                                payload = JSON.stringify(e.payload, undefined, 2);
                                if(payload.length > 200) {
                                    payloadTT = payload;
                                    payload = payload.substring(0, 200) + "...";
                                }
                            } catch (error) {
                                payload = typeof e.payload;
                            }
                        }

                        var info = ["<table>"];
                        info.push('<tr><td>Name</td><td>' + e.name + '</td></tr>');
                        info.push('<tr><td>Topic</td><td>' + e.topic + '</td></tr>');
                        info.push('<tr><td>PayloadType</td><td>' + e.payloadType + '</td></tr>');
                        if(payload) {
                            info.push('<tr><td title="' + payloadTT + '">Payload</td><td>' + payload + '</td></tr>');
                        }                       
                        info.push("</table>");
                        e.info = info.join("");

                        var details = ["<table>"];
                        if(e.expressionType == "solar"){
                            if(e.solarType == "all") details.push('<tr><td>solarType</td><td>' + e.solarType + '</td></tr>');
                            if(e.solarType == "selected") details.push('<tr><td>solarEvents</td><td>' + e.solarEvents + '</td></tr>');
                            details.push('<tr><td>location</td><td>' + e.location + '</td></tr>');
                            details.push('<tr><td>offset</td><td>' + e.offset + '</td></tr>');
                        } else {
                            details.push('<tr><td>expression</td><td>' + e.expression + '</td></tr>');
                        }
                        details.push("</table>");
                        e.details = details.join("");
                        return e;
                    });       
                    JSONtoTable(tableData, titles, $table, { class: "cron-plus-table", width: "100%", emptyMessage: "No dynamic schedules!" });    
                    $table.show();
                    $spinner.hide();
                    if(callback) callback();
                })
                .fail(function (jqXHR, textStatus, errorThrown) { 
                    if(callback) callback(errorThrown); 
                    console.error(jqXHR, textStatus, errorThrown);
                });
            }
            var dnRepositionResize = function(){
                var w = ($(document).width() < 800) ? "95%" : "80%";
                if(debug) console.log("dialog-open-drawDynamicSchedulesTable done - should now center and resize width", w);
                $("#cron-plus-dynamic-nodes-dialog").dialog("option", "width", w);
                $("#cron-plus-dynamic-nodes-dialog").dialog("option", "position", { my: "center", at: "center", of: window });
            };
            $( "#cron-plus-dynamic-nodes-dialog" ).dialog({
                autoOpen: false,
                height: getIdealDialogHeight(),
                // height: "auto",
                minHeight: 400,
                minWidth: 300,
                // maxWidth: 1000,
                modal: true,
                buttons: {
                    "Refresh": function() {
                        var node_id = $( "#cron-plus-dynamic-nodes-dialog" ).data("_cron_node_id");
                        drawDynamicSchedulesTable(node_id, "#cron-plus-dynamic-nodes-table-placeholder", "#cron-plus-dynamic-nodes-loader", dnRepositionResize);
                    },
                    "Close": function(){
                        $( "#cron-plus-dynamic-nodes-dialog" ).dialog( "close" );
                    }
                },
                show: {
                    effect: "fade",
                    duration: 250
                },
                // eslint-disable-next-line no-unused-vars
                open: function(event) {
                    $(this).css('padding', '0px 0px 0px 0px');
                    $('.ui-dialog-buttonpane').find('button:contains("Close")').addClass('primary');
                    var node_id = $( "#cron-plus-dynamic-nodes-dialog" ).data("_cron_node_id");
                    dnRepositionResize();
                    drawDynamicSchedulesTable(node_id, "#cron-plus-dynamic-nodes-table-placeholder", "#cron-plus-dynamic-nodes-loader", dnRepositionResize);
                },
                hide: {
                    effect: "fade",
                    duration: 250
                }
            });
            $( "#cron-plus-dynamic-nodes-dialog" ).data("_cron_node_id", node.id);
            dnRepositionResize();

            var tzData;
            $.ajax({
                url: "cronplus/0/tz",
                type: 'POST',
                datatype: 'json'
            })
            .done(function (data) { 
                tzData = data;
                $( "#node-input-timeZone" ).autocomplete({
                    source: function( request, response ) {
                        var matcher = new RegExp( $.ui.autocomplete.escapeRegex(request.term), "i" );
                        response($.map(tzData, function(item){
                            if(item && item.tz){
                                var label = (item.code ? item.code + ", " : "") + item.tz + " (UTC: " + item.UTCOffset + ", DST: " + item.UTCDSTOffset + ")";
                                if ( label && ( !request.term || matcher.test(label) ) ) {
                                    return {
                                        label: label,
                                        value: item
                                    };
                                }
                            }
                        }));
                    },
                    minLength: 1,
                    open: function() {
                        $( this ).removeClass( "ui-corner-all" ).addClass( "ui-corner-top" );
                    },
                    close: function() {
                        $( this ).removeClass( "ui-corner-top" ).addClass( "ui-corner-all" );
                    },
                    focus: function (event, ui) {
                        event.preventDefault();
                        $("#node-input-timeZone").val(ui.item.label);
                    },
                    select: function (event, ui) {
                        event.preventDefault();
                        this.value = ui.item.value.tz;
                    }
                });
                        
            })
            .fail(function (jqXHR, textStatus, errorThrown) { 
                console.error(jqXHR, textStatus, errorThrown);
            });

                

            var formatDateTimeWithTZ = function (date, tz) {
                if (!date) {
                    return "";
                }
                let dateString;
                let o = {
                    timeZone: tz ? tz : undefined,
                    timeZoneName: "short",
                    hour12: false,
                    year: "numeric",
                    month: "short",
                    day: "2-digit",
                    hour: "2-digit",
                    minute: "2-digit",
                    second: "2-digit"
                };
                try {
                    dateString = new Intl.DateTimeFormat('default', o).format(new Date(date));
                } catch (error) {
                    dateString = "Error. Check timezone setting";
                }
                return dateString;
            };
            var makeSolarChoice = function(value, label, tooltip){
                return { 
                    label: label, 
                    value: value || label, 
                    title: tooltip,
                    multiple: true
                };
            };
        
            var solarChoices = [
                makeSolarChoice("nightEnd", "night end / astronomical dawn", "night ends, astronomical twilight starts (-18°)"), //needed? same as astronomicalDawn
                // makeSolarChoice("astronomicalDawn", "astronomical dawn", "night ends, astronomical twilight starts (-18°)"), 
                makeSolarChoice("nauticalDawn", "nautical dawn", "astronomical twilight ends, nautical twilight starts (-12°)"),
                makeSolarChoice("civilDawn", "civil dawn / golden hour", "nautical twilight ends, civil twilight and golden hour starts (-6°)"),
                // makeSolarChoice("morningGoldenHourStart", "golden hour starts", "when the sun is 6 degrees below the horizon (-6°)"), //needed? same as civilDawn
                makeSolarChoice("sunrise", "sunrise", "top edge of the sun appears on the horizon (-0.833°)"),
                makeSolarChoice("sunriseEnd", "sunrise end", "bottom edge of the sun touches the horizon (-0.3°)"),
                makeSolarChoice("morningGoldenHourEnd", "morning golden hour ends", "when the sun is 6 degrees above the horizon (6°)"),
                makeSolarChoice("solarNoon", "solar noon", "sun is at its highest position"),
                makeSolarChoice("eveningGoldenHourStart", "evening golden hour start", "when the sun is 6 degrees above the horizon (6°)"),
                makeSolarChoice("sunsetStart", "sunset start", "bottom edge of the sun touches the horizon (-0.3°)"),
                makeSolarChoice("sunset", "sunset", "civil twilight starts, sun disappears below the horizon (-0.833°)"),
                // makeSolarChoice("eveningGoldenHourEnd", "evening golden hour end","golden hour ends (-6°)"), //needed? same as civilDusk
                makeSolarChoice("civilDusk", "civil dusk / golden hour end", "civil twilight and golden hour ends, nautical twilight starts (-6°)"),
                makeSolarChoice("nauticalDusk", "nautical dusk", "nautical twilight ends, astronomical twilight starts (-12°)"),
                // makeSolarChoice("astronomicalDusk", "astronomical dusk", "astronomical twilight ends, night starts (-18°)"),
                makeSolarChoice("nightStart", "astronomical dusk / night start", "astronomical twilight ends, night starts (-18°)"),  //needed? same as astronomicalDusk              
                makeSolarChoice("nadir", "solar midnight", "when the sun is closest to nadir and the night is equidistant from dusk and dawn"),
            ];
                
            function isObject(o){
                return (typeof o === 'object' && o !== null);
            }

            /** 
             * Apply defaults to the cron schedule object
             * @param {integer} optionIndex An index number to use for defaults
             * @param {object} option The option object to update
            */         
            function applyOptionDefaults(optionIndex, option) {
                if(isObject(option) == false){
                    return;//no point in continuing
                }
                // var version;
                // if( !option.version && option.expressionType !== "solar" && option.expressionType !== "dates" &&  
                //     (!option.name || !option.topic) && (!option.payloadType || option.type) ){
                //     version = 0;
                // } else {
                //     version = 1;
                // }                
                optionIndex = optionIndex == null ? 0 : optionIndex;
                if (["cron", "dates", "solar"].indexOf(option.expressionType) < 0){
                    //if expressionType is not cron or solar - it may be sunrise or sunset
                    if(option.expressionType == "sunrise"){
                        option.solarEvents = option.solarEvents || "sunrise";
                        option.expressionType = "solar";
                    } else if(option.expressionType == "sunset"){
                        option.solarEvents = option.solarEvents || "sunset";
                        option.expressionType = "solar";
                    } else {
                        if(!option.expression) {
                            option.expressionType = "cron";
                        } else {
                            if (!isCronLike(option.expression)) 
                                option.expressionType = "dates";
                            else if(isDateSequenceLike(option.expression))
                                option.expressionType = "dates";
                            else 
                                option.expressionType = "cron";
                        }
                    }   
                }
                option.name = option.name || "schedule" + (optionIndex + 1);
                option.topic = option.topic || "topic" + (optionIndex + 1);
                option.payloadType = option.payloadType || option.type || "default";
                delete option.type;                
                if (option.expressionType == "cron" && !option.expression) option.expression = "0 * * * * * *";
                if (!option.solarType) option.solarType =  option.solarEvents ? "selected" : "all";
                if (!option.solarEvents) option.solarEvents = "sunrise,sunset";
                if (!option.location) option.location = "";
                // option.version = 1; 
            }

            /** 
             * Generate an option row on the UI
             * @param {integer} optionIndex the index number of this schedule
             * @param {object} option The option object to present
            */             
            function generateOption(optionIndex, option) {
                applyOptionDefaults(optionIndex, option);
                function buildExpressionTip(title, desc, text, type){
                    var helpFuncHtml = '';
                    var helpFunc = type == "solar" ? "showSolarHelp" : "showCronHelp";
                    helpFuncHtml = '<span style="float: right"><button class="cron-plus-info-button" click="' + helpFunc + '();">help <i class="fa fa-external-link"></i></button></span>';
                    return '<div style="min-height:190px"><span style="font-size: 12px; font-weight: bold">' + title + '</span>' + helpFuncHtml +
                            '<hr><div>' + desc + '</div>' +
                            '<pre  class="cron-plus-form-tip form-tips">' + text + '</pre></div>';
                }
                function initTooltip(selector, type, pos){                    
                    selector.off("mouseenter").tooltip({
                        show: { effect: "fade" },
                        tooltipClass: "cron-plus-expression-tip form-tips",
                        position: pos,
                        content: function () { 
                            return buildExpressionTip("Expression...", "Getting description...", "", type); 
                        },
                        disabled: true
                    }).off('focusout').off('mouseleave').mouseleave(function(e){
                        if(debug) console.log("initTooltip--mouseleave");
                        if (selector.is(':focus')) {
                            if(debug) console.log("initTooltip--mouseleave selector:is(':focus')");
                            e.preventDefault();
                            e.stopImmediatePropagation();
                            //selector.tooltip('open');
                            return false;
                        }
                    }).on("blur", function (e) {
                        if(debug) console.log("initTooltip-->on-blur.  relatedTarget:", e.relatedTarget);
                        if(e.relatedTarget && e.relatedTarget.className == "cron-plus-info-button"){
                            if(debug) console.log('blur-->e.relatedTarget.relatedTarget.className == "cron-plus-info-button"');
                            if(type == "cron")
                                showCronHelp();
                            else if(type == "solar")
                                showSolarHelp();
                            $(this).focus();
                            // e.preventDefault();
                            // e.stopImmediatePropagation();
                            // //selector.tooltip('open');
                            return false;
                        }
                        $(this).tooltip("close").tooltip("disable");
                    }).on("focusin change keyup", function (e) {
                        if(debug) console.log("initTooltip--focusin change keyup", e );
                        var $this = $(this);
                        var expression = $this.val();
                        let $timeZone = $("#node-input-timeZone");
                        var $expressionType = $this.closest("li").find(".node-input-option-expressionType");
                        var $offset = $this.closest("li").find(".node-input-option-offset");
                        var $solarEvents = $this.closest("li").find(".node-input-option-solarEvents");
                        if(!expression){
                            $this.tooltip("close").tooltip("disable");
                            return;
                        }
                        
                        $this.tooltip("enable").tooltip("open");
                        $this.tooltip("option", "position", pos);
                        $this.tooltip({ 
                            position: pos,
                            disabled: false,
                            show: { effect: "fade" },
                            content: function (callback) {
                                if(debug) console.log("initTooltip-->content");
                                expression = $this.val();
                                var solarType = $solarEvents.typedInput("type");
                                var solarEvents = $solarEvents.typedInput("value");
                                var expressionType = $expressionType.val();
                                var offset = $offset.val();
                                let timeZone = $timeZone.val();
                                var title_html;
                                let e = { expressionType: expressionType };
                                if (timeZone) e.timeZone = timeZone;
                                if (expressionType == "solar"){
                                    title_html = '<b>solar events</b> at <span class="cron-plus-expression">' + expression.slice(0, 100) + (expression.length > 100 ? "..." : "") + '</span>';
                                    if(offset != undefined && offset != null && offset != "0" && offset != 0){
                                        title_html += '<b>';
                                        if(offset > 0) title_html += ' +';
                                        title_html += offset + ' minute';
                                        if(offset != "1" && offset != "-1") title_html += 's';
                                        title_html += '</b>';
                                    }
                                    e.offset = offset;
                                    e.location = expression;
                                    e.solarType = solarType;
                                    e.solarEvents = solarEvents;
                                } else {
                                    title_html = 'Description of <span class="cron-plus-expression">' + expression.slice(0, 50) + (expression.length > 50 ? "..." : "") + '</span>';
                                    e.expression = expression;
                                }

                                $.ajax({
                                    url: "cronplus/0/expressionTip",
                                    type: 'POST',
                                    data: e,
                                    datatype: 'json'
                                })
                                .done(function (data) {
                                    if(debug) console.log("initTooltip-->Ajax done, data...", data);
                                    let nextInfo = "";
                                    let desc = data.description;
                                    if (data.prettyNext) {
                                        nextInfo = "Next event: " + data.prettyNext;
                                        if (data.nextDates && data.nextDates.length) {
                                            nextInfo = nextInfo + " then...";
                                            var makeTR = function(x){
                                                var v = x, s = '<i class="fa fa-clock-o"></i>';
                                                if(typeof x === "object" && x.timeOffset){
                                                    v = x.timeOffset;
                                                    s = x.event || "unknown";
                                                }
                                                let fd = formatDateTimeWithTZ(v, timeZone);
                                                v = fd ? fd : undefined;
                                                return "<tr><td>" + s + "</td><td>" + v + "</td></tr>";
                                            };
                                            var map1 = data.nextDates.map(makeTR);
                                            nextInfo += "<table class=>" + map1.join("\n") + "</table>"; 
                                        }
                                    }
                                    var okContent = function(){
                                        setTimeout(function(){
                                            if(debug) console.log("initTooltip-->callback-->setTimeout--> option-->position");
                                            $this.tooltip("option", "position", pos);
                                            $this.tooltip("enable").tooltip("open");
                                            $this.tooltip("option", "position", pos);
                                        }, 200);
                                        return buildExpressionTip(title_html, desc, nextInfo, expressionType);
                                    }; 
                                    callback(okContent);
                                    $this.tooltip("option", "position", pos);
                                })
                                .fail(function (jqXHR, textStatus, errorThrown) {
                                    console.error(jqXHR, textStatus, errorThrown);
                                    var errContent = buildExpressionTip("Error...", "Cannot get description from node-red", "", expressionType);
                                    callback(errContent);
                                });
                            } 
                        });
                    });
                }
                
                
                var container, nameField, topicField, payloadField;
                var expressionTypeField, expressionField, solarEventsField, locationGroup, offsetField;
                //build options row
                container = $('<li/>', { style: "margin:0px 0px 5px 0px; padding:0px;" });
                var row = $('<div style="margin: 0px 0px 5px 0px"/>').appendTo(container);
                var row2 = $('<div style="margin: 0px 0px 5px 0px"/>').appendTo(container);
                
                var div = row.append( '<div/>' );

                var span = $('<span/>', { style: "float:right; margin-right:5px;" }).appendTo(div);
                var deleteButton = $('<a/>', { href: "#", class: "editor-button editor-button-small", style: "margin-top:27px; margin-left:5px;" }).appendTo(span);
                $('<i/>', { class: "fa fa-remove" }).appendTo(deleteButton);

                //generate the name field                              
                var nameClass = "node-input-option-name" + ((!option.name || dupCheck[option.name]) ? " input-error" : "");
                nameField = $('<input/>', { class: nameClass, type: "text", style: "margin-left:0px; width:calc(28% - 16px);", placeholder: 'name', title: "name", value: option.name }).appendTo(div);
                dupCheck[option.name] = true;

                //generate the topic field
                var topicClass = "node-input-option-topic" + ((!option.topic) ? " input-error" : "");
                topicField = $('<input/>', { class: topicClass, type: "text", style: "margin-left:5px; width:calc(32% - 16px);", placeholder: 'topic', title: "topic", value: option.topic }).appendTo(div);
                
                //generate the payload field
                payloadField = $('<input/>', { class: "node-input-option-payload", type: "text", style: "margin-left:5px; width:calc(40% - 25px);", placeholder: 'payload', value: option.payload || "" }).appendTo(div);
                payloadField.typedInput({
                    default: option.payloadType || 'default',
                    types: [{
                        icon: "fa fa-envelope",
                        value: "default",
                        label: "Default Payload",
                        hasValue: false 
                    }, 'flow', 'global', 'str', 'num', 'bool', 'json', 'jsonata', 'bin', 'date', 'env']
                });
                //generate a dropdown for trigger type
                var expressionType = option.expressionType || "cron";
                expressionTypeField = $('<select/>', { class: "node-input-option-expressionType", type: "text", placeholder: "cron" }).css({ "width": "calc(28% - 16px)", "margin-right": "5px" }).appendTo(row2);
                $('<option />', { value: "cron", text: "cron" }).appendTo(expressionTypeField);
                $('<option />', { value: "dates", text: "date sequence" }).appendTo(expressionTypeField);
                $('<option />', { value: "solar", text: "solar events" }).appendTo(expressionTypeField);
                expressionTypeField.val(expressionType);
                expressionTypeField.prop("title", "Expression Type");   
                


                //generate a combo for cron expression
                var expression = option.expression == null ? "0 * * * * * *" : option.expression;
                var expressionClass = "node-input-option-expression" + ((!expression) ? " input-error" : "");
                var expressionMenuData = [
                        { label: "Easy Expression Builder", value: "EEB" },
                        { label: "Every Second (* * * * * *)", value: "* * * * * *" },
                        { label: "Every minute (0 * * * * *)", value: "0 * * * * *" },
                        { label: "Every 10 minutes (0 */10 * * * *)", value: "0 */10 * * * *" },
                        { label: "Every 20 minutes, at 9:00 AM and 5:00 PM (0 */20 9,17 * * *)", value: "0 */20 9,17 * * *" },
                        { label: "At 15, 30, and 45 minutes past the hour (0 15,30,45 * * * *)", value: "0 15,30,45 * * * *" },
                        { label: "Every day at noon - 12pm (0 0 12 * * *)", value: "0 0 12 * * *" },
                        { label: "At 02:00 AM, on day 29 of Feb (0 0 2 29 FEB * 2020/4)", value: "0 0 2 29 FEB * 2020/4" },
                        { label: "At 07:00 AM, on the 1st Mon of the month (0 0 7 * * MON#1 *)", value: "0 0 7 * * MON#1 *" },
                        { label: "Every day at noon in Jan, Mar & Dec (0 0 12 * JAN,MAR,DEC *)", value: "0 0 12 * JAN,MAR,DEC *" },
                        { label: "Every minute, on the 1st weekday of the month (* * 1W * *)", value: "* * 1W * *" },
                        { label: "Every minute, on the third Tue of the month (* * * * Tue#3)", value: "* * * * Tue#3" },
                        { label: "At 12:00 PM, on the last Monday of the month (0 12 * * MONL)", value: "0 12 * * MONL" },
                    ];

                expressionField = $('<input/>', { class: expressionClass, type: "text", style: "margin-left:0px; width:calc(72% - 36px);", placeholder: '* * * * * * *', list: "cron-expression-example-list", title: "cron expression", value: option.expression }).appendTo(row2);
                expressionField.appendTo(row2);
   
                //setup the expression combo
                expressionField.combobox({
                    menu: {
                        menu: expressionMenuData,
                        options: { beforeSelect: function(opt) {
                            if(opt && opt.value == "EEB") {
                                $( "#cron-plus-expression-builder-dialog" ).data("opener", expressionField);
                                $( "#cron-plus-expression-builder-dialog" ).dialog( "open" );
                                return true; //return true to let widget know - we have handled this
                            }
                        } },
                    },
                    validate: function(value){
                        return (!!value) && value.length >= 9 ;//better validation required?
                    }
                });
                try {
                    expressionField.combobox().button.prop("title", "Expression examples...");
                    expressionField.combobox("instance").button.prop("title", "Expression examples...");                
                // eslint-disable-next-line no-empty
                } catch (error) {}
                expressionField.combobox("value", option.expression || "");

                //generate the solar events field
                solarEventsField = $('<input/>', { class: "node-input-option-solarEvents", type: "text", style: "margin-left:0px; width:calc(32% - 16px);", placeholder: 'select solar events', value: option.solarEvents || "" }).appendTo(row2);
                solarEventsField.typedInput({
                    default: "all",
                    types: [                    
                        {
                            value: "selected",
                            label: "Selected Solar Events", 
                            title: "Selected Solar Events", 
                            icon: "fa fa-list",
                            showLabel: false,
                            multiple: true,
                            options: solarChoices,
                            default: ["sunrise", "sunset"]
                        },
                        {
                            value: "all",
                            label: "All Solar Events",
                            title: "All Solar Events",
                            icon: "fa fa-sun-o",
                            hasValue: false,
                            showLabel: true 
                        }
                    ]
                });
                solarEventsField.typedInput("type", option.solarType || "all");
                solarEventsField.typedInput("value", option.solarEvents || "");//added as setting value on invocation doesnt seem to set the "2 selected" text of the widget!
                //generate location 
                locationGroup = $('<div class="red-ui-typedInput-container" style="margin-left:5px; width: calc(25% - 16px); /*display: inline-block;*/">' +
                        '<button class="red-ui-typedInput-type-select" style="width:25px" title="Show Map..."><i class="fa fa-map-marker "> </i></button>' +
                        '<div class="red-ui-typedInput-input red-ui-typedInput-input-wrap" style="left: 25px; right: 0px;">' +
                        '<input class="red-ui-typedInput-input node-input-option-location" type="text" value="" placeholder="lat lng"></div> </div>');                
                var locationField = locationGroup.find("input");
                var locationButton = locationGroup.find("button");
                locationField.prop("title", "Location coordinates...");
                locationButton.prop("title", "Show Map...");
                if(!option.location){
                    locationGroup.addClass("input-error");
                } else {
                    locationField.val(option.location);
                }
                locationGroup.appendTo(row2);

                locationButton.on( "click", function() {
                    selectedLocationInput = $(this).closest("li").find(".node-input-option-location");
                    $( "#cron-plus-map-dialog" ).dialog( "open" );
                    if(navigator.onLine === true){
                        $(".cron-plus-map-not-loaded").show();
                        $(".cron-plus-map-loading").hide();
                        $("#cron-plus-map").hide();
                        let proto = location.protocol === 'https:' ? location.protocol : "http:";
                        checkLoadJsCssFile(proto + "//libs.cartocdn.com/cartodb.js/v3/3.11/themes/css/cartodb.css", "css", function(){
                            checkLoadJsCssFile(proto + "//libs.cartocdn.com/cartodb.js/v3/3.11/cartodb.uncompressed.js", "js", function(){
                                createMap(selectedLocationInput);
                            });
                        });

                        /* google maps - future possibility...
                            https://jsfiddle.net/user2314737/8ndjuoyj/
                            checkLoadJsCssFile("https://maps.googleapis.com/maps/api/js?v=3&amp;sensor=false","js", function(){
                                createMap(selectedLocationInput);
                            })
                        */

                    } else {
                        $(".cron-plus-map-not-loaded").show();
                        $(".cron-plus-map-loading").hide();
                        $("#cron-plus-map").hide();
                        return;
                    }                      
                });

                //offset fields
                offsetField = $('<input/>', { class: "node-input-option-offset", type: "number", min: -1439, max: 1439, style: "margin-left:7px; width:calc(15% - 16px);", value: option.offset || 0, placeholder: "offset" }).appendTo(row2);
                offsetField.prop("title", "Minutes Offset +/- 1439");  
                
                //init tooltips
                initTooltip(locationField, "solar", { my: "right top", at: "right bottom+5", of: offsetField, collision: "flipfit" });
                initTooltip(expressionField, "cron", { my: "right top", at: "right bottom+5", of: expressionField /*expDropButton*/, collision: "flipfit" });

                locationField.keyup(function() {
                    var f = $(this);
                    var fg = locationGroup;
                    if (f.val() && fg.hasClass('input-error')) {
                        fg.removeClass('input-error');
                    } else if (!f.val()) {
                        fg.addClass('input-error');
                    }
                });
            
                nameField.keyup(function() {
                    if ($(this).val() && $(this).hasClass('input-error')) {
                        $(this).removeClass('input-error');
                    } else if (!$(this).val()) {
                        $(this).addClass('input-error');
                    }
                });                      
            
                locationField.change(function() {
                    if ($(this).val() && locationGroup.hasClass("input-error")) {
                        locationGroup.removeClass('input-error');
                    } else if (!$(this).val()) {
                        locationGroup.removeClass('input-error');
                    }
                });                      
            
                topicField.keyup(function() {
                    if ($(this).val() && $(this).hasClass('input-error')) {
                        $(this).removeClass('input-error');
                    } else if (!$(this).val()) {
                        $(this).addClass('input-error');
                    }
                });                      

                deleteButton.click(function() {
                    container.css({ "background": "#fee" });
                    container.fadeOut(300, function() {
                        $(this).remove();
                    });
                });
                
                expressionTypeField.change(function(){
                    var value = expressionTypeField.val();
                    switch (value) {
                        case "solar":
                            locationGroup.show();
                            // locationGroup.css("display","inline-block");
                            offsetField.show();
                            expressionField.combobox("hide");
                            solarEventsField.typedInput("show");
                            //solarEventsField.typedInput().css("display","inline-block");
                            solarEventsField.css("display", "inline-block");
                            break;
                        case "dates":
                            expressionField.combobox("show");
                            // expressionField.css("display","inline-block");
                            //expressionField.combobox().css("display","inline-block");
                            expressionField.combobox("hideMenu");
                            locationGroup.hide();
                            offsetField.hide();                            
                            solarEventsField.typedInput("hide");
                            break;
                        default: //cron
                            expressionField.combobox("show");
                            expressionField.combobox("showMenu");
                            // expressionField.combobox().css("display","inline-block");
                            // expressionField.css("display","inline-block");
                            locationGroup.hide();
                            offsetField.hide();                            
                            solarEventsField.typedInput("hide");
                            break;
                    }
                });
                expressionTypeField.change();
                $("#node-input-option-container").append(container);
            }

            $("#node-input-outputField").typedInput({ types: [{ label: "msg.", value: "str" }] });

            $("#node-input-add-option").click(function() {
                generateOption($("#node-input-option-container").children().length, {});
                $("#node-input-option-container-div").scrollTop($("#node-input-option-container-div").get(0).scrollHeight);
            });

            $("#node-input-show-dynamic").click(function() {
                $( "#cron-plus-dynamic-nodes-dialog" ).dialog( "open" );
            });

            for (var i = 0; i < this.options.length; i++) {
                var option = this.options[i];
                try {
                    generateOption(i, option);
                } catch (error) {
                    console.warn("generateOption caused an error: ", option, error);
                }
            }

            $( "#node-input-option-container" ).sortable({
                axis: "y",
                handle: ".node-input-option-handle",
                cursor: "move"
            });
            updateEditorLayout();
        },
        oneditsave: function () {
            var node = this;
            var options = $("#node-input-option-container").children();
            node.options = [];
            // eslint-disable-next-line no-unused-vars
            options.each(function(i) {
                var option = $(this);
                var o = {
                    name: option.find(".node-input-option-name").val(),
                    topic: option.find(".node-input-option-topic").val(),
                    payloadType: option.find(".node-input-option-payload").typedInput('type'),
                    payload: option.find(".node-input-option-payload").typedInput('value'),
                    expressionType: option.find(".node-input-option-expressionType").val(),
                    expression: option.find(".node-input-option-expression").val(),
                    location: option.find(".node-input-option-location").val(),
                    offset: option.find(".node-input-option-offset").val(),
                    solarType: option.find(".node-input-option-solarEvents").typedInput("type") || "all",
                    solarEvents: option.find(".node-input-option-solarEvents").typedInput("value")
                };
                if (option.find(".node-input-option-value").typedInput('type') === "num") {
                    o.payload = Number(o.value);
                }
                if (option.find(".node-input-option-value").typedInput('type') === "bool") {
                    o.payload = (o.value == "true");
                }
                node.options.push(o);
            });
            var o = $("#node-input-commandResponseMsgOutput").val();
            node.commandResponseMsgOutput = ["output1", "output2", "fanOut"].indexOf(o) >= 0 ? o : "output1";
            var fanOut = node.commandResponseMsgOutput == "fanOut";
            node.outputs = node.commandResponseMsgOutput === "output1" ? 1 : 2;
            if (fanOut && options && options.length) {
                node.outputs = options.length + 2; // in fanout mode, we add a separate output for dynamic schedules & command responses
            }
            $("#node-input-timeZone").off();
            $("#node-input-crontab").off();
        },
        button: {
            visible: function () {
                if(this.options && this.options.length == 1){
                    return true;
                }
                return false;
            },
            enabled: function () {
                return !this.changed;
            },
            onclick: function () {
                var node = this;
                if (node.changed) {
                    return RED.notify(RED._("notification.warning", { message: RED._("notification.warnings.undeployedChanges") }), "warning");
                }
                var label = node._def.label.call(node);
                if (label.length > 30) {
                    label = label.substring(0, 50) + "...";
                }
                label = label.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
                $.ajax({
                    url: "cronplusinject/" + node.id,
                    type: "POST",
                    // eslint-disable-next-line no-unused-vars
                    success: function (response) {
                        RED.notify(node._("inject.success", { label: label }), { type: "success", id: "inject" });
                    },
                    // eslint-disable-next-line no-unused-vars
                    error: function (jqXHR, textStatus, errorThrown) {
                        if (jqXHR.status == 404) {
                            RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.not-deployed") }), "error");
                        } else if (jqXHR.status == 500) {
                            RED.notify(node._("common.notification.error", { message: node._("inject.errors.failed") }), "error");
                        } else if (jqXHR.status == 0) {
                            RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.no-response") }), "error");
                        } else {
                            RED.notify(node._("common.notification.error", { message: node._("common.notification.errors.unexpected", { status: jqXHR.status, message: textStatus }) }), "error");
                        }
                    }
                });
            }
        },
        oneditresize: function(){
            // console.log("RESIZING")
            updateEditorLayout();
            //HACK for old versions of node-red - prior to typedInput resizing changed from code to CSS
            if(RED.settings.version && RED.settings.version.split(".")[0] < 1){
                var tics = $(".red-ui-typedInput-container");
                if(tics && tics.length){
                    var idx = 0;
                    for (idx = 0; idx < tics.length; idx++) {
                        var element = $(tics[idx]);
                        if(element && element.length && element.is(":visible") ){
                            element.css("display", "inline-block");
                        }
                    }
                } 
            }
        }
    });

})();    
</script>

<script type="text/html" data-template-name="cronplus">
    <style>
        .cron-select-period {
            padding: 5px 5px 0px 5px;
        }

        .cron-input {
            padding: 5px 5px 0px 5px;
        }

        .cron-select-period select,
        .cron-input select,
        .cron-input input[type=radio], 
        .cron-input input[type=checkbox] {
            margin-left: 5px;
            margin-right: 5px;
        }        

        table.cron-plus-table {
            border: solid 1px var(--red-ui-secondary-background);
            border-collapse: collapse;
            border-spacing: 0;
        }
        table.cron-plus-table th {
            background-color: var(--red-ui-primary-background);
            border: solid 1px var(--red-ui-secondary-background);
            color: #fff;
            text-align: left;
        }
        table.cron-plus-table > tr > td {
            font-family: monospace;
            font-size: 10pt;
            border: solid 1px var(--red-ui-secondary-background);
            color: var(--red-ui-primary-text-color);
            background: var(--red-ui-primary-background);
        }
        .cron-plus-form-row > label {
            width: 120px !important;
        }
        .cron-plus-expression-tip {
            background: var(--red-ui-primary-background);
            color: var(--red-ui-primary-text-color);
            width: 100%;
            max-width: 500px;
            max-height: 300px;
            overflow: auto;
            font-size: 10px;
        }
        .cron-plus-form-tip {
            background: var(--red-ui-primary-background);
            color: var(--red-ui-primary-text-color);
            padding: 6px 6px;
            vertical-align: middle;
            font-size: 12px;
            line-height: 20px;
            box-sizing: border-box;
            overflow: auto;
            word-break: keep-all;
        }
        .cron-plus-form-tip > div {
            white-space: pre-wrap;
        }
        span .cron-plus-form-tip {
            border-radius: 2px;
            border: 1px solid var(--red-ui-secondary-background);
            border-radius: 4px;
            display: inline-block;
        }
        .cron-plus-form-tip-spacer {
            display: inline-block;
            width: 100px
        }
        .cron-plus-expression {
            font-family: monospace;
            padding-left: 5px;
            padding-right: 5px;
            text-align: left;
            height: 30px;
            vertical-align: middle;
            border-bottom: 1px solid var(--red-ui-primary-text-color)
        }
        #cron-plus-map {
            /* height: 300px; */
            /* width: 100%; */
            height: 100%;
            padding: 0;
            margin: 0;
        }
        .cron-plus-map-dialog-content{
            padding: 0px 0px 0px 0px;
        }
        .cron-plus-map-not-loaded {
            padding: 2px 10px 2px 10px;
        }
        .cron-plus-map-loading {
            padding: 2px 10px 2px 10px;
        }
        .cron-plus-coordinates{
            font-family: monospace;
            background: var(--red-ui-primary-text-color);
            color: var(--red-ui-primary-background);
            padding-left: 5px;
            padding-right: 5px;
            border: 1px solid var(--red-ui-secondary-background);
        }
        pre .cron-plus-code {
            white-space: pre;
            font-size: 9px
        }
        .cron-plus-info-button {
            background: none!important;
            border: none!important;
            padding: 0!important;
            cursor: pointer!important;
            color: var(--red-ui-primary-text-color);
        }
        .cron-plus-solar-events-table {
            font-size: smaller;
            padding: 0px !important;
            margin: 0px !important;
            width: 100%;
            overflow-wrap: break-word;
            border: 1px solid;
        }
        .cron-plus-solar-events-table tr td {
            border: 1px dotted;
        }
        .cron-plus-solar-events-table tr th {
            text-align: left;
            border: 1px dotted;
        }
    </style>  

    <div id="cron-plus-map-dialog" style="display: none;" title="Choose location...">
        <div class="cron-plus-map-loading" >
            <h3>Attempting to load map... <i class="fa fa-spinner fa-spin" style="font-size:24px"></i></h3>
            <p>The interactive Map is loaded via CDN at client side (to minimise installation size) and therefore requires an internet connection. Please wait 1 moment.</p>
            <h4>Alternative ways to get coordinates...</h4>
            <ul> 
                <li>Visit <a href="https://www.latlong.net/" target="_blank" rel="noopener noreferrer">www.latlong.net</a> (on another device if required) then copy the "Lat Long" value provided into the cronplus coordinates box</li>
                <li>Visit google maps, MSN maps, almost any other maps website on another device to get GPS or longitude latitude value</li>
                <li>Try one of the many longitude latitude apps available in the app store on your mobile phone</li>
                <li>Check your satnav device - it may show coordinates</li>
                <li>Use a topographic map</li>
                <li>Ask a friend</li>
            </ul>
            <h4>Accepted formats...</h4> 
            <ul>
                <li>Decimal Degrees E.g: <code class="cron-plus-coordinates">54.9992500,-1.4170300</code> or <code class="cron-plus-coordinates">54.9992500° N 1.4170300° W</code></li>
                <li>Degrees Minutes Seconds E.g: <code class="cron-plus-coordinates">54° 59' 57.3'' N 1° 25' 1.308'' W</code></li>
                <li>Decimal Minutes E.g: <code class="cron-plus-coordinates">54° 59.955' , -1° 25.0218'</code></li>
                <li>GPS E.g: <code class="cron-plus-coordinates">N54°59'57.3, W1°25'1.308"</code>, <code class="cron-plus-coordinates">54°59'57.3"N, 1°25'1.308"W</code>, <code class="cron-plus-coordinates">54d 59' 57" N 1d 25' 1" W</code> or <code class="cron-plus-coordinates">54:59:57.3N 1:25:1.308W</code></li>
            </ul>    
        </div>
        <div class="cron-plus-map-not-loaded"  style="display:hidden" >
            <h3>No internet on this device?</h3>
            <p>The interactive Map is loaded via CDN at client side (to minimise installation size) and therefore requires an internet connection. As you are seeing this message, it is likely this device does not have access to the internet.</p>
            <h4>Alternative ways to get coordinates...</h4>
            <ul> 
                <li>Visit <a href="https://www.latlong.net/" target="_blank" rel="noopener noreferrer">www.latlong.net</a> (on another device if required) then copy the "Lat Long" value provided into the cronplus coordinates box</li>
                <li>Visit google maps, MSN maps, almost any other maps website on another device to get GPS or longitude latitude value</li>
                <li>Try one of the many longitude latitude apps available in the app store on your mobile phone</li>
                <li>Check your satnav device - it may show coordinates</li>
                <li>Use a topographic map</li>
                <li>Ask a friend</li>
            </ul>
            <h4>Accepted formats...</h4>
            <ul>
                <li>Decimal Degrees E.g: <code class="cron-plus-coordinates">54.9992500,-1.4170300</code> or <code class="cron-plus-coordinates">54.9992500° N 1.4170300° W</code></li>
                <li>Degrees Minutes Seconds E.g: <code class="cron-plus-coordinates">54° 59' 57.3'' N 1° 25' 1.308'' W</code></li>
                <li>Decimal Minutes E.g: <code class="cron-plus-coordinates">54° 59.955' , -1° 25.0218'</code></li>
                <li>GPS E.g: <code class="cron-plus-coordinates">N54°59'57.3, W1°25'1.308"</code>, <code class="cron-plus-coordinates">54°59'57.3"N, 1°25'1.308"W</code>, <code class="cron-plus-coordinates">54d 59' 57" N 1d 25' 1" W</code> or <code class="cron-plus-coordinates">54:59:57.3N 1:25:1.308W</code></li>
            </ul>
        </div>
        <div id="cron-plus-map"></div>
    </div>

    <div id="cron-plus-dynamic-nodes-dialog" style="display: none;" title="Dynamic schedules...">
        <div id="cron-plus-dynamic-nodes-table-placeholder"  style="display: flex;align-items: center;/*justify-content: center;*/">
        </div>
        <div id="cron-plus-dynamic-nodes-loader" style="position: absolute;  left: 46%;  top: 46%;">
            <i class="fa fa-spinner fa-spin" style="font-size:48px"></i>
        </div>
    </div>
    <div id="cron-plus-expression-builder-dialog" style="display: none;" title="Easy Expression Builder...">
        <div id="cron-plus-expression-builder" >
        </div>
    </div>    
    <div class="form-row cron-plus-form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name">Name</span></label>
        <input type="text" id="node-input-name" placeholder="Name">
    </div>
    <!-- <div class="form-row cron-plus-form-row">
        <label for="node-input-config"><i class="icon-globe"></i><span data-i18n="common.label.config"> Config</span></label>
        <input type="text" id="node-input-config">
    </div> -->
    <div class="form-row cron-plus-form-row">
        <label for="node-input-outputField"><i class="fa fa-sign-out"></i> Output property</label>
        <input type="text" id="node-input-outputField" style="width: 70%" placeholder="payload">
    </div>         
    <div class="form-row cron-plus-form-row">
        <label for="node-input-timeZone"><i class="fa fa-globe"></i> Timezone</label>
        <input type="text" id="node-input-timeZone" placeholder="Leave empty for none/system">
    </div>  
    <div class="form-row cron-plus-form-row">
        <label for="node-input-commandResponseMsgOutput"><i class="fa fa-dot-circle-o"></i> Outputs</label>
        <select style="width: 70%" id="node-input-commandResponseMsgOutput">
          <option value="output1">1 output: All messages to output 1</option>
          <option value="output2">2 outputs: Schedule messages to output 1, command responses to output 2</option>
          <option value="fanOut" >Fan out: Separate outputs for static, dynamic and command messages</option>
        </select>
    </div> 
    <div class="form-row cron-plus-form-row">
        <label>&nbsp;</label>
        <input type="checkbox" id="node-input-persistDynamic" style="display:inline-block; width:15px; vertical-align:baseline;" autocomplete="off">
        <label style="width: 30% !important;" for="node-input-persistDynamic" title="Auto save and reload dynamic schedules">Persist dynamic schedules</label>
    </div>
    <div id="node-cronplus-tab-static-schedules" class="form-row cron-plus-form-row form-row-auto-height" style="margin-bottom: 0px;width: 100%; min-height: 200px">
        <label for="node-input-option-container-div" style="vertical-align:top"><i class="fa fa-list-alt"></i> Schedules</label>
        <div class="red-ui-editableList-border red-ui-editableList-container" id="node-input-option-container-div" 
            style="min-width: 300px; box-sizing: border-box; border-radius: 5px; padding: 5px; overflow-y:scroll;display: inline-block; width: 100%; height: calc(100% - 28px); min-height: 150px;">
            <ol id="node-input-option-container" style=" list-style-type:none; margin: 0;"></ol>
        </div>
    </div> 
    <div class="form-row cron-plus-form-row">
        <a href="#" class="editor-button editor-button-small" id="node-input-add-option" style="margin-top: 4px;"><i class="fa fa-plus"></i> <span>add</span></a>
        <a href="#" class="editor-button editor-button-small" id="node-input-show-dynamic" style="margin-top: 4px;"><i class="fa fa-table"></i> <span>view dynamic schedules</span></a>
    </div>
</div>

</script>

<script type="text/html" data-help-name="cronplus">
    <p>Schedule the injection of a payload to start a flow</p>
    <h3>Properties...</h3>
    <dl class="message-properties">
        <h4>Output property</h4>
        <div style="padding-left: 15px">
            The <code>msg.</code> property to send the payload to.  Typically this would be payload.
        </div>
        <h4>Timezone (optional)</h4>
        <div style="padding-left: 15px">
            A timezone to use. Leave blank for system timezone. Alternatively, enter UTC or a timezone in the format of Region/Area (<a target="_blank" href="https://en.wikipedia.org/wiki/List_of_tz_database_time_zones">list</a>)
            <br>
            TIP: Timezone should be perceived from your own perspective. See the <a href="#understanding-timezone">Understanding Timezone</a> example below.
        </div>    
        <h4>Outputs</h4>
        <div style="padding-left: 15px">
            <ul>
                <li>1 output: All messages to output 1 (schedules + command responses)</li>
                <li>2 outputs: Schedule messages to output 1, command responses to output 2</li>
                <li>Fan out: Separate outputs for static, dynamic and command messages</li>
            </ul>
        </div>    
        <h4>Persist dynamic schedules</h4>
        <div style="padding-left: 15px">
            Enabling this option causes dynamic schedules to be saved to file and re-loaded when the cron-plus node is loaded or re-deployed. <br>
            NOTES...
            <ul>
                <li>Any time an update to any dynamic schedule occurs, all dynamic schedules are saved to file</li>
                <li>The schedules are saved in a directory called <code>cronplusdata</code> under your node-red folder</li>
            </ul>
        </div>    
        <h4>Schedules</h4>
        <div style="padding-left: 15px">
            A table of schedules. Entries here are considered static and will be reloaded when node-red starts or the cron-plus node is (re)deployed.
        </div>
        <h4>Schedules - Name</h4>
        <div style="padding-left: 15px">
            The name is used to identify the schedule. Dynamic adjustments to an individual schedule will need to specify this name.
        </div>
        <h4>Schedules - Topic</h4>
        <div style="padding-left: 15px">
            The topic will be sent in <code>msg.topic</code> when the schedule triggers. This is to permit the flow to act on the triggered schedule.
        </div>
        <h4>Schedules - Payload</h4>
        <div style="padding-left: 15px">
            The value to send in the payload when the schedule triggers. (NOTE: the property that the payload gets written to is determined by "Output property").
        </div>
        <h4>Schedules - Type</h4>
        <div style="padding-left: 15px">
            The type determines what type of schedule. Options are <code>cron</code>, <code>dates sequence</code> or <code>solar events</code>
        </div>
        <h4 id="cron-plus-expression-info">Schedules - Expression</h4>
        <div style="padding-left: 15px">
            <i>NOTE: Only displayed when the type is set to <b>cron</b> or <b>date sequence</b></i><br>
            A CRON expression, a date, a comma separated list of dates or an array of dates<br><br>
            <p> Date or Date Sequence Format...<br>
                When you wish to use a fixed date or sequence of dates, the expression can be a string date, comma separated list of dates, an array of dates (The array can contain a mix of string, date objects and timestamps).
                When specifying a string date, you can use timezone e.g. "2020-01-01 00:00 GMT+2".
                You can even mix time zones e.g. "2020-01-01 00:00 GMT+2, 2020-01-01 00:00 GMT-7"
            </p>
            <p>CRON Format...</p>
            <pre style="white-space: pre; padding: 0px; font-size: smaller;"> * * * * * * *    Field              Allowed values    Special symbols
 | | | | | | |    -----------------  ---------------   ---------------
 `-|-|-|-|-|-|->  Second (optional)  0-59              * / , -
   `-|-|-|-|-|->  Minute             0-59              * / , -
     `-|-|-|-|->  Hour               0-23              * / , -
       `-|-|-|->  Day of Month       1-31              * / , - ? L W
         `-|-|->  Month              1-12 or JAN-DEC   * / , -
           `-|->  Day of Week        0-7 or SUN-SAT    * / , - ? L #
             `->  Year (optional)    1970-2099         * / , -</pre>
            <p>Notes...</p>
            <ul>
                <li><code>*</code> Asterisks indicate that the cron expression matches for all values of the field. For example, "*" in the minute field means every minute</li>
                <li><code>?</code> Question marks are used to specify 'no specific value' and is allowed for the day-of-month and day-of-week fields. It is used instead of the asterisk (*) for leaving either day-of-month or day-of-week blank.</li>
                <li><code>-</code> Hyphens are used to define ranges. For example, "10-12" in the hour field means the hours of 10, 11, and 12.</li>
                <li><code>,</code> Commas are used to separate items of a list. For example, "MON,WED,FRI" in the day-of-week field means the days Monday, Wednesday, and Friday.</li>
                <li><code>/</code> Forward slash are used to indicate increments. For example. "0/15" in the seconds field means the seconds 0, 15, 30, and 45. Additionally, "1/3" in the day-of-month field means every 3 days starting on the first day of the month.</li>
                <li><code>L</code> Short-hand for "last" and is allowed for the day-of-month and day-of-week fields. The "L" character has a different meaning in each of the two fields. For example, "L" in the day-of-month field means the last day of the month. If used in the day-of-week field, it means 7 or SAT. However, if used in the day-of-week field after another value, it means the last xxx day of the month. For example, "6L" in the day-of-week field means the last Friday of the month</li>
                <li><code>W</code> Short-hand for "weekday" and is allowed for the day-of-month field. The "W" character is used to specify the weekday nearest the given day. For example, "15W" in the day-of-month field means the nearest weekday to the 15th of the month. Therefore, if the 15th is a Saturday, the job runs on Friday the 14th. The "L" and "W" characters can be combined in the day-of-month field. For example, "LW" means the last weekday of the month.</li>
                <li><code>#</code> Hash marks specify constructs. For example, "6#3' in the day-of-week field means the third Friday of the month.</li>
            </ul>        
            <p>Examples...</p>
            <ul>
                <li><code>* * * * * *</code> Every Second</li>
                <li><code>0 * * * * *</code> Every minute</li>
                <li><code>0 */10 * * * *</code> Every 10 minutes</li>
                <li><code>0 */20 1 * * *</code> Every 20 minutes, between 01:00 AM and 01:59 AM</li>
                <li><code>0 15,30,45 * * * *</code> At 15, 30, and 45 minutes past the hour</li>
                <li><code>0 0 12 * * *</code> Every day at noon - 12pm</li>
                <li><code>0 0 2 29 FEB * 2020/4</code> At 02:00 AM, on day 29 of February (leap years)</li>
                <li><code>0 0 7 * * MON#1 *</code> At 07:00 AM, on the first Monday of the month</li>
                <li><code>0 0 12 * JAN,FEB,MAR,APR *</code> Every day at noon in January, February, March and April</li>
                <li><code>* * 1W * *</code> Every minute, on the first weekday of the month</li>
                <li><code>* * * * Tue#3</code> Every minute, on the third Tuesday of the month</li>
                <li><code>0 12 * * MONL</code> At 12:00 PM, on the last Monday of the month</li>
                <li>See <a href="https://github.com/jaclarke/cronosjs">here</a> for more examples and info</li>
            </ul>
        </div>
        <h4 id="cron-plus-solar-events-info">Schedules - Solar Events</h4>
        <div style="padding-left: 15px">
            <i>NOTE: Only displayed when the type is set to <b>solar events</b></i><br>
            The Solar Events field permits you to chose which solar events you want a schedule to fire upon.<br>
            Solar Events...
            <table class="cron-plus-solar-events-table">
                <tr><th>Event ID</th><th>Event</th><th>Information</th></tr>
                <tr><td>nightEnd</td><td>night end / astronomical dawn</td><td>night ends, astronomical twilight starts (-18°)</td></tr>
                <!-- <tr><td>astronomicalDawn</td><td>astronomical dawn</td><td>night ends, astronomical twilight starts (-18°)")</td></tr> -->
                <tr><td>nauticalDawn</td><td>nautical dawn</td><td>astronomical twilight ends, nautical twilight starts (-12°)</td></tr>
                <tr><td>civilDawn</td><td>civil dawn / golden hour</td><td>nautical twilight ends, civil twilight and golden hour starts (-6°)</td></tr>
                <!-- <tr><td>morningGoldenHourStart</td><td>golden hour starts</td><td>when the sun is 6 degrees below the horizon (-6°)")</td></tr> -->
                <tr><td>sunrise</td><td>sunrise</td><td>top edge of the sun appears on the horizon (-0.833°)</td></tr>
                <tr><td>sunriseEnd</td><td>sunrise end</td><td>bottom edge of the sun touches the horizon (-0.3°)</td></tr>
                <tr><td>morningGoldenHourEnd</td><td>morning golden hour ends</td><td>when the sun is 6 degrees above the horizon (6°)</td></tr>
                <tr><td>solarNoon</td><td>solar noon</td><td>sun is at its highest position</td></tr>
                <tr><td>eveningGoldenHourStart</td><td>evening golden hour start</td><td>when the sun is 6 degrees above the horizon (6°)</td></tr>
                <tr><td>sunsetStart</td><td>sunset start</td><td>bottom edge of the sun touches the horizon (-0.3°)</td></tr>
                <tr><td>sunset</td><td>sunset</td><td>civil twilight starts, sun disappears below the horizon (-0.833°)</td></tr>
                <!-- <tr><td>eveningGoldenHourEnd</td><td>evening golden hour end</td><td>golden hour ends (-6°)")</td></tr> -->
                <tr><td>civilDusk</td><td>civil dusk / golden hour end</td><td>civil twilight and golden hour ends, nautical twilight starts (-6°)</td></tr>
                <tr><td>nauticalDusk</td><td>nautical dusk</td><td>nautical twilight ends, astronomical twilight starts (-12°)</td></tr>
                <!-- <tr><td>astronomicalDusk</td><td>astronomical dusk</td><td>astronomical twilight ends, night starts (-18°)</td></tr> -->
                <tr><td>nightStart</td><td>astronomical dusk / night start</td><td>astronomical twilight ends, night starts (-18°)</td></tr>
                <tr><td>nadir</td><td>solar midnight</td><td>when the sun is closest to nadir and the night is equidistant from dusk and dawn</td></tr>
            </table>
        </div>
        <h4>Schedules - Location</h4>
        <div style="padding-left: 15px">
            <i>NOTE: Only displayed when the type is set to <b>solar events</b></i><br>
            The location field is expected to contain longitude and latitude coordinates for the calculation of solar events.<br>
            Accepted formats...
            <ul>
                <li>Decimal Degrees E.g: <code class="cron-plus-coordinates">54.9992500,-1.4170300</code> or <code class="cron-plus-coordinates">54.9992500° N 1.4170300° W</code></li>
                <li>Degrees Minutes Seconds E.g: <code class="cron-plus-coordinates">54° 59' 57.3'' N 1° 25' 1.308'' W</code></li>
                <li>Decimal Minutes E.g: <code class="cron-plus-coordinates">54° 59.955' , -1° 25.0218'</code></li>
                <li>GPS E.g: <code class="cron-plus-coordinates">N54°59'57.3, W1°25'1.308"</code>, <code class="cron-plus-coordinates">54°59'57.3"N, 1°25'1.308"W</code>, <code class="cron-plus-coordinates">54d 59' 57" N 1d 25' 1" W</code> or <code class="cron-plus-coordinates">54:59:57.3N 1:25:1.308W</code></li>
            </ul>
        </div>        
        <h4>Schedules - Offset</h4>
        <div style="padding-left: 15px">
            <i>NOTE: Only displayed when the type is set to <b>solar events</b></i><br>
            The offset field can be used to add a positive or negative offset in minutes to the sunrise or sunset time.
        </div>        

    </dl>
    <h3>Output</h3>
    <dl class="message-properties">
        <dt><i>payload (see 'Output property')</i> <span class="property-type">number|string|boolean|object|buffer</span></dt>
        <dd>msg.[Output property] will contain whatever is configured in 'payload'</dd>
        <dd>e.g. if 'Output property' is set to <b>data.value</b> then <code>msg.data.value</code> will contain the value of the <i>payload</i></dd>
        <dd>msg.topic will contain the name of the schedule. This simplifies separating out which schedule has triggered</dd>
        <dd>Additional properties are also added to the msg object. Check the debug output (use show complete msg)</dd>
    </dl>

    <h3>Inputs <i>(Advanced Usage)</i></h3>
    <dl class="message-properties">
        <dt><i>topic</i> <span class="property-type">string</span></dt>
        <dd>Most of the commands can be provided in the topic with the name of schedule in the payload (where appropriate). <br>Supported command topics... 
                    <ul>
                        <li>trigger</li>
                        <li>status</li>
                        <li>export</li>
                        <li>remove</li>
                        <li>pause</li>
                        <li>stop</li>
                        <li>start</li>
            </ul>
            This includes the <code>-all</code>, <code>-all-dynamic</code>, <code>-all-static</code>, <code>-active</code>,  <code>-active-dynamic</code>,  <code>-active-static</code>, <code>-inactive</code>, <code>-inactive-all-dynamic</code> and <code>-inactive-static</code> command topics (e.g. export-all, stop-all-dynamic, start-all-static, remove-inactive-dynamic)<br>
            See <a href="#cron-plus-commands-info">commands</a> below for details.
        </dd>
    <dl class="message-properties">
        <dt><i>payload</i> <span class="property-type">string|object|Array</span></dt>
        <dd>It is possible to dynamically add, remove and control schedules by injecting a payload into the node. The format of the payload object (or array of objects) depends on the operation. See below for details.</dd>
        <dd>
            <p><b>Adding one (or more) schedules</b><br>
                Example...<br>
                <pre class="cron-plus-code">payload: [
  {
    "command": "add",
    "name": "every 6",
    "expression": "*/6 * * * * * *",
    "expressionType": "cron",
    "payloadType": "default",
    "limit": 3 
  },
  {
    "command": "add",
    "name": "new years eve 2030",
    "expression": "2030-01-01",
    "expressionType": "dates",
    "payloadType": "default"
  },
  {
    "command": "add",
    "name": "alarm1",
    "expressionType": "solar",
    "solarType": "selected",
    "solarEvents": "civilDawn,sunrise,sunset",
    "location": "54.999320540937035 -1.417407989501953",
    "offset": "-60",
    "payloadType": "str",
    "payload": "In 60 mins, it will be a great time to take photographs",
    "limit": null
  }
]</pre>
                
                <p><i>Details...</i><br>
                    Adding a CRON expression
                    <ul>
                        <li>Multiple schedules can be added if the payload is an array of objects</li>
                        <li>command: (string|required) The operation to perform - in this case "add"</li>
                        <li>name: (string|required) This will identify schedule</li>
                        <li>topic: (string|required) This will be used as the topic when the schedule triggers</li>
                        <li>expression: (string|required) A CRON expression, a date, a comma separated list of dates or an array of dates</li>
                        <li>expressionType: (string|optional) specify the schedule type. (if omitted, "cron" is the default)</li>
                        <li>payloadType: (string|optional) The payload type (e.g. 'default', 'flow', 'global', 'str', 'num', 'bool', 'json', 'bin', 'date' or 'env')</li>
                        <li>payload: (any|optional) What to send when schedule triggers</li>
                        <li>limit: (number|optional) Maximum number of times the schedule should trigger</li>
                    </ul><br>
                    Adding a date sequence
                    <ul>
                        <li>Multiple schedules can be added if the payload is an array of objects</li>
                        <li>command: (string|required) The operation to perform - in this case "add"</li>
                        <li>name: (string|required) This will identify schedule</li>
                        <li>topic: (string|required) This will be used as the topic when the schedule triggers</li>
                        <li>expression: (string|array|required) A date, a comma separated list of dates or an array of dates</li>
                        <li>expressionType: (string|required) specify the schedule type - in this case "dates"</li>
                        <li>payloadType: (string|optional) The payload type (e.g. 'default', 'flow', 'global', 'str', 'num', 'bool', 'json', 'bin', 'date' or 'env')</li>
                        <li>payload: (any|optional) What to send when schedule triggers</li>
                        <li>limit: (number|optional) Maximum number of times the schedule should trigger</li>
                    </ul><br>
                    Adding a solar event schedule
                    <ul>
                        <li>Multiple schedules can be added if the payload is an array of objects</li>
                        <li>command: (string|required) The operation to perform - in this case "add"</li>
                        <li>name: (string|required) This will identify schedule</li>
                        <li>topic: (string|required) This will be used as the topic when the schedule triggers</li>
                        <li>expressionType: (string|required) specify the schedule type. Set to "solar" for solar events</li>
                        <li>solarType: (string|required) specify the events to fire.  Accepted values are "all" or "selected"</li>
                        <li>solarEvents: (string|optional) specify the events to fire. Only required when solarType == "selected". Accepted values are listed under <b>Schedules - Solar Events</b> <a href="#cron-plus-solar-events-info">see above</a> </li>
                        <li>location: (string|required) longitude latitude, DNS, DMM or GPS coordinates for sunrise or sunset</li>
                        <li>offset: (number|optional) number of minutes to offset a sunrise or sunset</li>
                        <li>payloadType: (string|optional) The payload type (e.g. 'default', 'flow', 'global', 'str', 'num', 'bool', 'json', 'bin', 'date' or 'env')</li>
                        <li>payload: (any|optional) What to send when schedule triggers</li>
                        <li>limit: (number|optional) Maximum number of times the schedule should trigger</li>
                    </ul>
                </p>
            </p>
            <p><i>Notes...</i><br>
                <ul>
                    <li>This option has no output.</li>
                </ul>
            </p>

            <p id="cron-plus-commands-info"><b>Getting status of a schedule or removing / stopping / pausing / starting a schedule</b><br><br>
                Topic Method...<br>
                <pre class="cron-plus-code">msg.topic = "command"; // command name - *see details below*,
msg.payload = "name"; //  name of the schedule</pre>
                Payload Method...<br>
                <pre class="cron-plus-code">payload: {
  "command": "*see details below*",
  "name": "* name of schedule",
}</pre>
                <p><i>Details...</i><br>
                    <ul>
                        <li>command: (string|required) The operation to perform - this can be one of the following...
                            <ul>
                                <li>"trigger"</li>
                                <li>"status"</li>
                                <li>"export"</li>
                                <li>"remove"</li>
                                <li>"stop"</li>
                                <li>"pause"</li>
                                <li>"start"</li>
                            </ul>
                        </li>
                        <li>name: (string|optional) The name of the schedule to affect (not required when using the -all, -active or -inactive filters)</li>
                    </ul>
                </p>
                <p><i>Notes...</i><br>
                    <ul>
                        <li><code>trigger</code> fires schedule named in <code>msg.payload</code> </li>
                        <li><code>status</code> returns an object with the config and status of the named schedule</li>
                        <li><code>export</code> returns an object with the config of the named schedule</li>
                        <li><code>remove</code> will stop and remove the schedule. This option has no output.</li>
                        <li><code>stop</code> will stop the schedule specified by <code>name</code> and reset its internal counter. This option has no output.</li>
                        <li><code>pause</code> will stop the schedule specified by <code>name</code> but will not reset its internal counter. This option has no output.</li>
                        <li><code>start</code> will (re)start all schedules. Any schedule that reached its limit will start from the beginning. Paused schedules will resume. This option has no output.</li>
                        <li>FILTER: adding <code>-all</code> to any of these commands will operate on all schedules. e.g. <code>status-all</code> will return the status of all schedules</li>
                        <li>FILTER: adding <code>-all-dynamic</code> to any of these commands will only affect dynamic schedules e.g. <code>remove-all-dynamic</code> will remove all dynamic schedules</li>
                        <li>FILTER: adding <code>-all-static</code> to any of these commands will only affect static schedules e.g. <code>stop-all-static</code></li>
                        <li>FILTER: adding <code>-active</code> to status, export and remove commands will operate on all active schedules. e.g. <code>status-active</code> </li>
                        <li>FILTER: adding <code>-active-static</code> to status, export and remove commands will operate on all static schedules that are active. e.g. <code>status-active-static</code></li>
                        <li>FILTER: adding <code>-active-dynamic</code> to status, export and remove commands will operate on all dynamic schedules that are active. e.g. <code>status-active-dynamic</code></li>
                        <li>FILTER: adding <code>-inactive</code> to status, export and remove commands will operate on all inactive schedules. e.g. <code>status-inactive</code> </li>
                        <li>FILTER: adding <code>-inactive-static</code> to status, export and remove commands will operate on all static schedules that are inactive. e.g. <code>status-inactive-static</code></li>
                        <li>FILTER: adding <code>-inactive-dynamic</code> to status, export and remove commands will operate on all dynamic schedules that are inactive. e.g. <code>status-inactive-dynamic</code></li>
                    </ul>
                </p>
                <p><i>Examples...</i><br>
                    Example : Using a simple topic command to manually trigger a schedule named "schedule1"<br>
                    <pre class="cron-plus-code">msg: {
  "topic": "trigger",
  "payload": "schedule1"
}</pre>                    
                    Example : Using a simple topic command to export all dynamically added schedules...<br>
                    <pre class="cron-plus-code">msg: {
  "topic": "export-all-dynamic"
}</pre>                    
                    Example : Using a simple topic command to delete a schedule named "schedule1"<br>
                    <pre class="cron-plus-code">msg: {
  "topic": "remove",
  "payload": "schedule1"
}</pre>                    
                    Example : Using a cmd payload to pause all schedules...<br>
                    <pre class="cron-plus-code">payload: {
  "command": "pause-all"
}</pre> 
                    Example : Using a simple topic command to delete all dynamic schedules that have finished <br>
                    <pre class="cron-plus-code">msg: {
  "topic": "remove-inactive-dynamic"
}</pre>                    
                </p>
            </p>
            </p>

                 

            <p><b>Describe</b><br>
                Example : cmd payload to describe a cron expression...<br>
                <pre class="cron-plus-code">{
  "command": "describe",
  "expressionType": "cron",
  "expression": "0 */5 * * * MON *",
  "timeZone": "Europe/London"
}</pre>
                Example : cmd payload to get all solar event times + solar state at this time...<br>
<pre class="cron-plus-code">{
  "command": "describe",
  "expressionType": "solar",
  "location": "54.9992500,-1.4170300",
  "solarType": "all",
  "timeZone": "Europe/London"
}</pre>
                Example : cmd payload to get 4 solar event times + solar for a specific point in time...<br>
    <pre class="cron-plus-code">{
  "command": "describe",
  "expressionType": "solar",
  "time": "2020-03-22 18:40",
  "location": "54.9992500,-1.4170300",
  "solarType": "selected",
  "solarEvents": "civilDawn,sunrise,sunset,civilDusk",
  "timeZone": "Europe/London"
}</pre>
                <p><i>Details...</i><br>
                    Returns an object in payload containing human readable info for the given expression.
                    <ul>
                        <li>command: (string|required) The operation to perform</li>
                        <li>expression: (string|required) The expression to describe</li>
                        <li>timeZone: (string|optional) A timezone to use. Leave blank for system timezone. Alternatively, enter UTC or a timezone in the format of Region/Area (<a target="_blank" href="https://en.wikipedia.org/wiki/List_of_tz_database_time_zones">list</a>) </li>
                    </ul>
                </p>
            </p>                
        </dd>
        <dd>GENERAL NOTES...<br>
            <ul>
                <li>Adding a schedule with the same name as an existing schedule will replace the existing one</li>
                <li>Adding a schedule with property <code>"limit":3</code> will cause that schedule to be stopped after the third trigger. It can be started again by injecting a payload of <code>{"command":"start" "name": "schedule name"}</code></li>
                <li>Static (UI added) schedules can be also be updated by using the name specified in the UI</li>
                <li>When a cron-plus-plus node is modified and deployed (or node-red is restarted), dynamic entries are discarded and must be injected again</li>
                <li>When a cron-plus-plus node outputs a msg in response to a command, <code>msg.commandResponse</code> will be <code>true</code> to indicate the message is in response to a command and not a scheduled event</li>
                <li>When a cron-plus-plus node outputs a msg for a cron/solar event, <code>msg.scheduledEvent</code> will be <code>true</code> to indicate the message is due to a scheduled event and not a control response</li>
                <li>The status indicator will be shown as a "ring" for dynamic schedules or shown as a "dot" for static schedules</li>
                <li>if the payload is to "Default Payload", then the content of <code>msg.cronplus</code> is moved to <code>msg.payload</code></li>
            </ul>
        </dd>
    </dl>

    <h3 id="understanding-timezone">Understanding Timezone...</h3>
    <dl class="message-properties">
        <h4>Foreword</h4>
        <p>Timezone should be perceived from your current point of view. For example, regardless of where your node-red runs, you can "fake it" by setting the Timezone entry to your own Timezone location where/when you expect the event to occur.
        </p>

        <h4><b>Example 1...</b></h4>
        <p>Trigger a flow when the NYSE stock exchange starts and stops trading.
        </p>

        <h4 id="notes">NOTES</h4>
        <ul>
            <li>This example will work all year around but was written on 15th Apr with <code>GMT+1 / BST</code> and <code>GMT-4 / EDT</code> as a point of reference</li>
            <li>Server is in London (GMT+1 / BST)</li>
            <li>NYSE Stock exchange runs 09:30 ~ 16:00 Monday to Friday</li>
        </ul>

        <h4 id="details">DETAILS</h4>
        <ul>
            <li>NY time 09:30 (GMT-4 / EDT) - this is the time the market opens in New York</li>
            <li>Server time 14:30 (GMT+1 / BST equivalent) - the start event will happen at this time in london</li>
            <li>NY time 16:00 (GMT-4 / EDT) - this is the time the market closes in New York</li>
            <li>Server time 21:00 (GMT+1 / BST equivalent) - the stop event will happen at this time in london</li>
        </ul>

        <h4 id="setup">SETUP</h4>
        <ul>
            <li>Enter <code>America/New_York</code> in the <code>Timezone</code> field</li>
            <li>Add a new schedule...
                <ul>
                    <li>Field 1 (name)      : Enter &quot;NYSEOPEN &quot;</li>
                    <li>Field 2 (topic)     : Enter &quot;stocks/nyse/trading&quot;</li>
                    <li>Field 3 (payload)   : Select boolean - true</li>
                    <li>Field 4 (type)      : Select &quot;cron&quot;</li>
                    <li>Field 5 (expression): Enter the expression <code>0 30 9 * * 1-5</code></li>                    
                </ul>
            </li>
            <li>Add a new schedule...
                <ul>
                    <li>Field 1 (name)      : Enter &quot;NYSECLOSE &quot;</li>
                    <li>Field 2 (topic)     : Enter &quot;stocks/nyse/trading&quot;</li>
                    <li>Field 3 (payload)   : Select boolean - false</li>
                    <li>Field 4 (type)      : Select &quot;cron&quot;</li>
                    <li>Field 5 (expression): Enter the expression <code>0 0 16 * * 1-5</code></li>
                </ul>
            </li>
        </ul>  
        
        <p></p>         

        <h4><b>Example 2...</b></h4>
        <p>Get an reminder (in Moscow) to call my wife 30 mins after the sun rises in Cairo.</p>

        <h4 id="notes">NOTES</h4>
        <ul>
            <li>This example will work all year around but was written on 15th Apr as a point of reference</li>
            <li>Server is in London (GMT+1 / BST)</li>
            <li>My wife in on holiday in Cairo (GMT+2)
                <ul>
                    <li>sunrise is at 05:27 in Cairo on 15-Apr</li>
                </ul>
            </li>
            <li>I am away on business in Moscow (GMT+3)
                <ul>
                    <li>I need an alert to call wife 30 mins after Cairo sunrise</li>
                </ul>
            </li>
        </ul>

        <h4 id="details">DETAILS</h4>
        <ul>
            <li>Cairo sunrise time 05:27 (15-apr) - 30 mins later at 05:57, my wife expects a call.</li>
            <li>Server time 04:57 (GMT+1 equivalent) - the event will happen at this time in london</li>
            <li>Moscow time 06:57 (GMT+3 equivalent) - this is the time it will be in Moscow</li>
        </ul>

        <h4 id="setup">SETUP</h4>
        <ul>
            <li>Enter <code>Europe/Moscow</code> in the <code>Timezone</code> field</li>
            <li>Add a new schedule...
                <ul>
                    <li>Field 1 (name)    : Enter &quot;call reminder&quot;</li>
                    <li>Field 2 (topic)   : Enter &quot;call/wife&quot;</li>
                    <li>Field 3 (payload) : Select default</li>
                    <li>Field 4 (type)    : Select &quot;solar events&quot;</li>
                    <li>Field 5 (Events)  : Select &quot;sunrise&quot;</li>
                    <li>Field 6 (location): Enter the coordinates for sunrise location (Cairo) <code>30.04905845622014 31.229496002197262</code></li>
                    <li>Field 7 (offset)  : Enter an offset of 30 (allow her time to make a coffee)</li>
                </ul>
            </li>
        </ul>   

    </dl>
    
</script>